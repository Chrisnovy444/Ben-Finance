<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ben Wallet - Gestion Financière Intelligente</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS pour export Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    
    <!-- Balises d'icônes PWA générées par favicon.io -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <link rel="shortcut icon" href="favicon.ico">
    
    <!-- Configuration PWA -->
    <meta name="theme-color" content="#C41E3A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ben Wallet">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#C41E3A">
    
    <style>
        :root {
            --primary-color: #C41E3A; /* Rouge principal */
            --secondary-color: #8B0000; /* Rouge foncé */
            --accent-color: #FFD700; /* Or */
            --accent-dark: #B8860B; /* Or foncé */
            --success-color: #2E8B57;
            --danger-color: #DC143C;
            --warning-color: #FF8C00;
            --info-color: #4169E1;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --sidebar-width: 260px;
            --header-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #8B0000 0%, #C41E3A 100%);
            min-height: 100vh;
            display: flex;
            color: var(--dark-color);
        }

        .app-container {
            display: flex;
            width: 100%;
            min-height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.15);
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            color: white;
            padding: 25px 0;
            display: flex;
            flex-direction: column;
            border-right: 3px solid var(--accent-color);
        }

        .logo {
            padding: 0 25px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 25px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .logo-img {
            height: 55px;
            width: 55px;
            border-radius: 15px;
            border: 3px solid var(--accent-color);
            object-fit: contain;
            background: linear-gradient(135deg, white 0%, #f8f9fa 100%);
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .logo-text h1 {
            font-size: 26px;
            font-weight: 800;
            margin: 0;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #ffffff 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .logo-text span {
            color: var(--accent-color);
        }

        .logo-subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 3px;
            color: var(--accent-color);
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        /* Bouton menu hamburger pour mobile */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--accent-color);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .menu-toggle:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .nav-menu {
            flex: 1;
        }

        .nav-item {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left-color: var(--accent-color);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
            color: var(--accent-color);
        }

        .user-section {
            padding: 20px 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--secondary-color);
            font-size: 16px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            height: var(--header-height);
            background: white;
            border-bottom: 1px solid #eee;
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            height: 40px;
            width: 40px;
            border-radius: 8px;
            object-fit: contain;
            background: white;
            border: 1px solid var(--accent-color);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .header-title h2 {
            font-size: 22px;
            color: var(--secondary-color);
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--light-color);
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .date-selector select {
            border: none;
            background: transparent;
            font-weight: 500;
            outline: none;
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #f9f5f0;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            border-top: 4px solid var(--primary-color);
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(196, 30, 58, 0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 16px;
            color: #6c757d;
            font-weight: 600;
        }

        .card-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--dark-color);
            margin-bottom: 10px;
        }

        .card-positive {
            color: var(--success-color);
        }

        .card-negative {
            color: var(--danger-color);
        }

        .card-progress {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
        }

        .progress-bar {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
        }

        /* Transaction Form */
        .transaction-form {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 40px;
            border: 1px solid #f0e6d6;
        }

        .form-title {
            font-size: 20px;
            margin-bottom: 25px;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: #fff;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(196, 30, 58, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #1E6B42 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #1E6B42 0%, var(--success-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 139, 87, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #A31027 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #A31027 0%, var(--danger-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 20, 60, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-dark) 100%);
            color: var(--secondary-color);
            font-weight: 800;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, var(--accent-dark) 0%, var(--accent-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color) 0%, #2a4da1 100%);
            color: white;
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #2a4da1 0%, var(--info-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(65, 105, 225, 0.3);
        }

        /* Allocation Display */
        .allocation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .allocation-item {
            background: #fff9f0;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        .allocation-title {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .allocation-value {
            font-size: 20px;
            font-weight: 800;
            color: var(--dark-color);
        }

        .allocation-sent {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 14px;
        }

        .sent-badge {
            background: var(--success-color);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .not-sent-badge {
            background: var(--danger-color);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Transactions Table */
        .transactions-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #f0e6d6;
        }

        .table-header {
            padding: 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(90deg, #fff 0%, #fff9f0 100%);
        }

        .table-header h3 {
            color: var(--secondary-color);
            font-size: 20px;
            font-weight: 700;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            padding: 18px 20px;
            text-align: left;
            background: #fff9f0;
            color: #555;
            font-weight: 700;
            border-bottom: 1px solid #eee;
        }

        td {
            padding: 18px 20px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #fff9f0;
        }

        .transaction-income {
            border-left: 4px solid var(--success-color);
        }

        .transaction-expense {
            border-left: 4px solid var(--danger-color);
        }

        .transaction-type {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .type-income {
            background: rgba(46, 139, 87, 0.15);
            color: var(--success-color);
            border: 1px solid rgba(46, 139, 87, 0.3);
        }

        .type-expense {
            background: rgba(220, 20, 60, 0.15);
            color: var(--danger-color);
            border: 1px solid rgba(220, 20, 60, 0.3);
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-sent {
            background: rgba(46, 139, 87, 0.15);
            color: var(--success-color);
            border: 1px solid rgba(46, 139, 87, 0.3);
        }

        .status-pending {
            background: rgba(255, 140, 0, 0.15);
            color: var(--warning-color);
            border: 1px solid rgba(255, 140, 0, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s;
            border: 3px solid var(--accent-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(90deg, #fff 0%, #fff9f0 100%);
        }

        .modal-header h3 {
            color: var(--secondary-color);
            font-weight: 700;
        }

        .modal-body {
            padding: 25px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--primary-color);
            font-weight: bold;
            transition: all 0.3s;
        }

        .close-modal:hover {
            color: var(--secondary-color);
            transform: scale(1.1);
        }

        .proof-image {
            width: 100%;
            border-radius: 10px;
            margin-top: 15px;
            max-height: 300px;
            object-fit: contain;
            border: 2px solid var(--accent-color);
        }

        .tab-container {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 25px;
            background: #fff9f0;
            border-radius: 8px 8px 0 0;
            padding: 5px;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            border-radius: 6px;
        }

        .tab:hover {
            background: rgba(196, 30, 58, 0.1);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--accent-color);
            background: rgba(196, 30, 58, 0.15);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .account-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .account-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-top: 5px solid var(--primary-color);
        }

        .account-card .card-header {
            margin-bottom: 15px;
        }

        .account-balance {
            font-size: 28px;
            font-weight: 800;
            color: var(--dark-color);
            margin-bottom: 10px;
        }

        .account-history {
            margin-top: 20px;
            font-size: 14px;
            color: #6c757d;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        /* Graphiques */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-top: 20px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        /* Styling spécifique pour les icônes */
        .fa-chart-line, .fa-wallet, .fa-exchange-alt, .fa-hand-holding-usd, 
        .fa-chart-bar, .fa-cog, .fa-piggy-bank, .fa-money-bill-wave,
        .fa-church, .fa-hands-helping, .fa-hard-hat, .fa-hand-holding-heart {
            color: var(--primary-color);
        }


        @media (max-width: 992px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 15px 0;
            }
            
            .nav-menu {
                display: none;
                flex-direction: column;
                max-height: 70vh;
                overflow-y: auto;
                padding: 0;
            }
            
            .nav-menu.active {
                display: flex;
            }
            
            .nav-item {
                white-space: nowrap;
                border-left: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                padding: 18px 25px;
            }
            
            .nav-item.active {
                border-left: none;
                border-bottom: 3px solid var(--accent-color);
            }
            
            .user-section {
                display: none;
            }
            
            .content {
                padding: 20px;
            }
            
            .logo-container {
                justify-content: space-between;
                padding: 0 20px;
            }
            
            .header-title {
                gap: 10px;
            }
            
            .header-logo {
                height: 35px;
                width: 35px;
            }
            
            .menu-toggle {
                display: block;
            }
            
            .logo-text {
                flex: 1;
                text-align: center;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-card {
                padding: 20px;
            }
        }
        /* Styles pour l'export CSV */
        #export-preview .preview-content {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.5;
        }

        /* Style pour les lignes d'en-tête dans l'aperçu */
        #export-preview .preview-content div:first-child {
            font-weight: bold;
            background-color: #e9ecef;
            border-bottom: 2px solid #495057;
        }

        /* Animation pour la prévisualisation */
        @keyframes previewPulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        .preview-loading {
            animation: previewPulse 1.5s infinite;
        }

        /* Responsive pour le modal d'export */
        @media (max-width: 768px) {
            #export-modal .modal-content {
                width: 95%;
                margin: 10px;
            }
            
            #export-modal .form-grid {
                grid-template-columns: 1fr !important;
            }
            
            #export-modal .modal-body > div {
                margin-bottom: 15px;
            }
        }
        /* Toaster notifications */
        #toast-container {
            position: fixed;
            right: 20px;
            top: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            min-width: 220px;
            max-width: 360px;
            background: white;
            color: #333;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            border-left: 6px solid var(--primary-color);
            pointer-events: auto;
            display: flex;
            gap: 12px;
            align-items: center;
            font-weight: 600;
        }

        .toast.success { border-left-color: var(--success-color); }
        .toast.warning { border-left-color: var(--warning-color); }
        .toast.info { border-left-color: var(--info-color); }
        .toast.danger { border-left-color: var(--danger-color); }

        /* Confirm modal tweaks */
        #confirm-modal .modal-content { max-width: 420px; }
        #confirm-modal .confirm-actions { display:flex; gap:12px; justify-content:flex-end; margin-top:12px; }
    </style>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker enregistré avec succès pour Ben Wallet');
                    })
                    .catch(err => {
                        console.log('Échec de l\'enregistrement du ServiceWorker:', err);
                    });
            });
        }
    </script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar avec Logo -->
        <div class="sidebar">
            <!-- REMPLACER la section .logo actuelle par : -->
<div class="logo">
    <div class="logo-container">
        <button class="menu-toggle" id="menu-toggle">
            <i class="fas fa-bars"></i>
        </button>
        <img src="android-chrome-512x512.png" alt="Ben Wallet Logo" class="logo-img">
        <div class="logo-text">
            <h1>Ben<span>Wallet</span></h1>
            <div class="logo-subtitle">Gestion financière intelligente</div>
        </div>
    </div>
</div>
   
         
            <div class="nav-menu" id="nav-menu">
                <div class="nav-item active" data-tab="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Tableau de bord</span>
                </div>
                <div class="nav-item" data-tab="transactions">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Transactions</span>
                </div>
                <div class="nav-item" data-tab="accounts">
                    <i class="fas fa-wallet"></i>
                    <span>Mes comptes</span>
                </div>
                <div class="nav-item" data-tab="allocations">
                    <i class="fas fa-hand-holding-usd"></i>
                    <span>Allocations</span>
                </div>
                <div class="nav-item" data-tab="budgets">
                    <i class="fas fa-chart-pie"></i>
                    <span>Budgets</span>
                </div>
                <div class="nav-item" data-tab="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>Rapports</span>
                </div>
                <div class="nav-item" data-tab="converter">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Convertisseur</span>
                </div>
                <div class="nav-item" data-tab="contacts">
                    <i class="fas fa-users"></i>
                    <span>Contacts</span>
                </div>
                <div class="nav-item" data-tab="faq">
                    <i class="fas fa-question-circle"></i>
                    <span>FAQ & Aide</span>
                </div>
                <div class="nav-item" data-tab="rewards">
                    <i class="fas fa-trophy"></i>
                    <span>Récompenses</span>
                    <span class="notification-badge" id="new-badges-count" style="display: none;">0</span>
                </div>
                <div class="nav-item" data-tab="settings">
                    <i class="fas fa-cog"></i>
                    <span>Paramètres</span>
                </div>
            </div>
            
            <div class="user-section">
                <div class="user-avatar" id="user-avatar-display">JD</div>
                <div>
                    <div style="font-weight: 800;" id="user-name-display">John Doe</div>
                    <div style="font-size: 14px; opacity: 0.9;" id="user-status-display">Utilisateur Premium</div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header avec Logo -->
            <div class="header">
                <div class="header-title">
                    <img src="android-chrome-192x192.png" alt="Ben Wallet" class="header-logo">
                    <h2 id="page-title">Tableau de bord</h2>
                </div>
                
                <div class="header-actions">
                    <div class="date-selector">
                        <i class="far fa-calendar-alt" style="color: var(--primary-color);"></i>
                        <select id="month-select">
                            <option value="1">Janvier</option>
                            <option value="2">Février</option>
                            <option value="3">Mars</option>
                            <option value="4">Avril</option>
                            <option value="5">Mai</option>
                            <option value="6">Juin</option>
                            <option value="7">Juillet</option>
                            <option value="8">Août</option>
                            <option value="9">Septembre</option>
                            <option value="10">Octobre</option>
                            <option value="11">Novembre</option>
                            <option value="12">Décembre</option>
                        </select>
                        <select id="year-select">
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" id="add-transaction-btn">
                        <i class="fas fa-plus"></i> Nouvelle transaction
                    </button>
                </div>
            </div>
            
            <!-- Content -->
            <div class="content">
                <!-- Dashboard Tab -->
                <div class="tab-content active" id="dashboard">
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Solde total</div>
                                <i class="fas fa-wallet" style="color: var(--primary-color); font-size: 24px;"></i>
                            </div>
                            <div class="card-value" id="total-balance">0 FCFA</div>
                            <div class="card-progress">
                                <div class="progress-bar" style="width: 75%;"></div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Épargne obligatoire</div>
                                <i class="fas fa-piggy-bank" style="color: var(--accent-color); font-size: 24px;"></i>
                            </div>
                            <div class="card-value" id="savings-balance">0 FCFA</div>
                            <div>Objectif mensuel: <span id="savings-target">0 FCFA</span></div>
                            <div class="card-progress">
                                <div class="progress-bar" style="width: 60%;"></div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Investissement</div>
                                <i class="fas fa-chart-line" style="color: var(--secondary-color); font-size: 24px;"></i>
                            </div>
                            <div class="card-value" id="investment-balance">0 FCFA</div>
                            <div>Objectif mensuel: <span id="investment-target">0 FCFA</span></div>
                            <div class="card-progress">
                                <div class="progress-bar" style="width: 45%;"></div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Disponible</div>
                                <i class="fas fa-money-bill-wave" style="color: var(--success-color); font-size: 24px;"></i>
                            </div>
                            <div class="card-value" id="available-balance">0 FCFA</div>
                            <div>Pour dépenses courantes</div>
                            <div class="card-progress">
                                <div class="progress-bar" style="width: 30%;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Transaction Form -->
                    <div class="transaction-form">
                        <div class="form-title">
                            <i class="fas fa-plus-circle"></i> Nouvelle transaction
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="transaction-type">Type de transaction</label>
                                <select id="transaction-type" class="form-control">
                                    <option value="income">Entrée d'argent</option>
                                    <option value="expense">Dépense</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="transaction-amount">Montant</label>
                                <input type="number" id="transaction-amount" class="form-control" placeholder="Ex: 50000">
                            </div>
                            
                            <div class="form-group">
                                <label for="transaction-source">Source / Destinataire</label>
                                <input type="text" id="transaction-source" class="form-control" placeholder="Ex: Salaire, Paul, Epicerie...">
                            </div>
                            
                            <div class="form-group">
                                <label for="transaction-date">Date</label>
                                <input type="date" id="transaction-date" class="form-control" value="">
                            </div>
                            
                            <div class="form-group">
                                <label for="transaction-time">Heure</label>
                                <input type="time" id="transaction-time" class="form-control" value="">
                            </div>
                            
                            <div class="form-group">
                                <label for="transaction-category">Catégorie</label>
                                <select id="transaction-category" class="form-control">
                                    <option value="salary">Salaire</option>
                                    <option value="gift">Cadeau</option>
                                    <option value="business">Affaires</option>
                                    <option value="other">Autre</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="transaction-description">Description (optionnel)</label>
                                <input type="text" id="transaction-description" class="form-control" placeholder="Détails supplémentaires...">
                            </div>
                        </div>
                        
                        <div id="allocation-preview" style="display: none;">
                            <div style="font-weight: 700; margin-bottom: 15px; color: var(--primary-color);">
                                <i class="fas fa-calculator"></i> Répartition automatique
                            </div>
                            <div class="allocation-grid">
                                <!-- Les allocations seront générées dynamiquement -->
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 25px;">
                            <button class="btn btn-primary" id="calculate-allocation-btn">
                                <i class="fas fa-calculator"></i> Calculer la répartition
                            </button>
                            <button class="btn btn-success" id="save-transaction-btn" style="display: none;">
                                <i class="fas fa-save"></i> Enregistrer la transaction
                            </button>
                            <button class="btn btn-danger" id="cancel-transaction-btn" style="display: none;">
                                <i class="fas fa-times"></i> Annuler
                            </button>
                        </div>
                    </div>
                    
                    <!-- Recent Transactions -->
                    <div class="transactions-table">
                        <div class="table-header">
                            <h3>Dernières transactions</h3>
                            <button class="btn btn-primary" id="view-all-transactions">
                                <i class="fas fa-list"></i> Voir tout
                            </button>
                        </div>
                        
                        <div class="table-container">
                            <table id="recent-transactions-table">
                                <thead>
                                    <tr>
                                        <th>Date & Heure</th>
                                        <th>Description</th>
                                        <th>Source/Destinataire</th>
                                        <th>Type</th>
                                        <th>Montant</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-transactions-body">
                                    <!-- Les transactions récentes seront chargées ici -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Transactions Tab -->
                <div class="tab-content" id="transactions">
                    <div class="tab-container">
                        <div class="tab active" data-transaction-tab="all">Toutes</div>
                        <div class="tab" data-transaction-tab="income">Entrées</div>
                        <div class="tab" data-transaction-tab="expense">Dépenses</div>
                        <div class="tab" data-transaction-tab="allocated">Allouées</div>
                    </div>
                    
                    <div class="transactions-table">
                        <div class="table-header">
                            <h3>Historique des transactions</h3>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="transaction-search" class="form-control" placeholder="Rechercher une transaction..." style="width: 250px;">
                                <button class="btn btn-primary" id="filter-transactions">
                                    <i class="fas fa-filter"></i> Filtrer
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table id="all-transactions-table">
                                <thead>
                                    <tr>
                                        <th>Date & Heure</th>
                                        <th>Description</th>
                                        <th>Source/Destinataire</th>
                                        <th>Type</th>
                                        <th>Montant total</th>
                                        <th>Compte source</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="all-transactions-body">
                                    <!-- Toutes les transactions seront chargées ici -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Accounts Tab -->
                <div class="tab-content" id="accounts">
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Dîme (10%)</div>
                                <i class="fas fa-church" style="color: var(--danger-color); font-size: 24px;"></i>
                            </div>
                            <div class="card-value" id="tithe-balance">0 FCFA</div>
                            <div id="tithe-status">Non envoyée</div>
                            <div style="margin-top: 20px;">
                                <button class="btn btn-danger" id="send-tithe-btn">
                                    <i class="fas fa-paper-plane"></i> Marquer comme envoyée
                                </button>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Offrande (5%)</div>
                                <i class="fas fa-hands-helping" style="color: var(--warning-color); font-size: 24px;"></i>
                            </div>
                            <div class="card-value" id="offering-balance">0 FCFA</div>
                            <div id="offering-status">Non envoyée</div>
                            <div style="margin-top: 20px;">
                                <button class="btn btn-warning" id="send-offering-btn">
                                    <i class="fas fa-paper-plane"></i> Marquer comme envoyée
                                </button>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Bâtisseurs (10%)</div>
                                <i class="fas fa-hard-hat" style="color: var(--info-color); font-size: 24px;"></i>
                            </div>
                            <div class="card-value" id="builders-balance">0 FCFA</div>
                            <div id="builders-status">Non envoyée</div>
                            <div style="margin-top: 20px;">
                                <button class="btn btn-info" id="send-builders-btn">
                                    <i class="fas fa-paper-plane"></i> Marquer comme envoyée
                                </button>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Aumône (5%)</div>
                                <i class="fas fa-hand-holding-heart" style="color: #9b59b6; font-size: 24px;"></i>
                            </div>
                            <div class="card-value" id="alms-balance">0 FCFA</div>
                            <div id="alms-status">Non envoyée</div>
                            <div style="margin-top: 20px;">
                                <button class="btn btn-info" style="background: #9b59b6;" id="send-alms-btn">
                                    <i class="fas fa-paper-plane"></i> Marquer comme envoyée
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="account-cards">
                        <div class="account-card">
                            <div class="card-header">
                                <div class="card-title">Épargne obligatoire (15%)</div>
                                <i class="fas fa-piggy-bank" style="color: var(--success-color); font-size: 24px;"></i>
                            </div>
                            <div class="account-balance" id="savings-account-balance">0 FCFA</div>
                            <div>Depuis: <span id="savings-start-date">-</span></div>
                            <div class="account-history">
                                <div class="history-item">
                                    <span>Dernière transaction</span>
                                    <span id="savings-last-transaction">-</span>
                                </div>
                                <div class="history-item">
                                    <span>Total déposé ce mois</span>
                                    <span id="savings-month-total">0 FCFA</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="account-card">
                            <div class="card-header">
                                <div class="card-title">Investissement (15%)</div>
                                <i class="fas fa-chart-line" style="color: var(--accent-dark); font-size: 24px;"></i>
                            </div>
                            <div class="account-balance" id="investment-account-balance">0 FCFA</div>
                            <div>Depuis: <span id="investment-start-date">-</span></div>
                            <div class="account-history">
                                <div class="history-item">
                                    <span>Dernière transaction</span>
                                    <span id="investment-last-transaction">-</span>
                                </div>
                                <div class="history-item">
                                    <span>Total investi ce mois</span>
                                    <span id="investment-month-total">0 FCFA</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="account-card">
                            <div class="card-header">
                                <div class="card-title">Disponible (40%)</div>
                                <i class="fas fa-money-bill-wave" style="color: var(--primary-color); font-size: 24px;"></i>
                            </div>
                            <div class="account-balance" id="available-account-balance">0 FCFA</div>
                            <div>Pour dépenses courantes</div>
                            <div class="account-history">
                                <div class="history-item">
                                    <span>Dépenses ce mois</span>
                                    <span id="month-expenses">0 FCFA</span>
                                </div>
                                <div class="history-item">
                                    <span>Solde du mois dernier</span>
                                    <span id="last-month-balance">0 FCFA</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Allocations Tab -->
                <div class="tab-content" id="allocations">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-title">Règles d'allocation</div>
                            <i class="fas fa-sliders-h" style="color: var(--primary-color); font-size: 24px;"></i>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <div style="font-weight: 700; margin-bottom: 15px; color: var(--primary-color);">
                                Pour chaque entrée d'argent, répartition automatique:
                            </div>
                            
                            <div class="allocation-grid">
                                <div class="allocation-item" style="border-left-color: var(--danger-color);">
                                    <div class="allocation-title">Dîme</div>
                                    <div class="allocation-value">10%</div>
                                    <div class="allocation-sent">
                                        <span>Statut: </span>
                                        <span class="not-sent-badge" id="tithe-allocation-status">Non envoyée</span>
                                    </div>
                                </div>
                                
                                <div class="allocation-item" style="border-left-color: var(--warning-color);">
                                    <div class="allocation-title">Offrande</div>
                                    <div class="allocation-value">5%</div>
                                    <div class="allocation-sent">
                                        <span>Statut: </span>
                                        <span class="not-sent-badge" id="offering-allocation-status">Non envoyée</span>
                                    </div>
                                </div>
                                
                                <div class="allocation-item" style="border-left-color: var(--info-color);">
                                    <div class="allocation-title">Bâtisseurs</div>
                                    <div class="allocation-value">10%</div>
                                    <div class="allocation-sent">
                                        <span>Statut: </span>
                                        <span class="not-sent-badge" id="builders-allocation-status">Non envoyée</span>
                                    </div>
                                </div>
                                
                                <div class="allocation-item" style="border-left-color: #9b59b6;">
                                    <div class="allocation-title">Aumône</div>
                                    <div class="allocation-value">5%</div>
                                    <div class="allocation-sent">
                                        <span>Statut: </span>
                                        <span class="not-sent-badge" id="alms-allocation-status">Non envoyée</span>
                                    </div>
                                </div>
                                
                                <div class="allocation-item" style="border-left-color: var(--success-color);">
                                    <div class="allocation-title">Épargne</div>
                                    <div class="allocation-value">15%</div>
                                    <div class="allocation-sent">
                                        <span>Votre épargne</span>
                                    </div>
                                </div>
                                
                                <div class="allocation-item" style="border-left-color: var(--accent-dark);">
                                    <div class="allocation-title">Investissement</div>
                                    <div class="allocation-value">15%</div>
                                    <div class="allocation-sent">
                                        <span>Votre investissement</span>
                                    </div>
                                </div>
                                
                                <div class="allocation-item" style="border-left-color: var(--primary-color);">
                                    <div class="allocation-title">Disponible</div>
                                    <div class="allocation-value">40%</div>
                                    <div class="allocation-sent">
                                        <span>Pour vos dépenses</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 40px;">
                            <div style="font-weight: 700; margin-bottom: 15px; color: var(--primary-color);">
                                Historique des allocations ce mois
                            </div>
                            
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date & Heure</th>
                                            <th>Montant source</th>
                                            <th>Dîme</th>
                                            <th>Offrande</th>
                                            <th>Bâtisseurs</th>
                                            <th>Aumône</th>
                                            <th>Épargne</th>
                                            <th>Investissement</th>
                                            <th>Disponible</th>
                                        </tr>
                                    </thead>
                                    <tbody id="allocations-history-body">
                                        <!-- L'historique des allocations sera chargé ici -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Budgets Tab -->
                <div class="tab-content" id="budgets">
    <div class="dashboard-grid">
        <div class="dashboard-card">
            <div class="card-header">
                <div class="card-title">Budget mensuel</div>
                <i class="fas fa-calendar-alt" style="color: var(--primary-color); font-size: 24px;"></i>
            </div>
            
            <div class="form-grid" style="margin-top: 15px;">
                <div class="form-group">
                    <label for="monthly-income-budget">Revenus prévus</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="monthly-income-budget" class="form-control" placeholder="0">
                        <button class="btn btn-success" id="auto-calc-income" style="white-space: nowrap;">
                            <i class="fas fa-calculator"></i> Auto
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="monthly-expense-budget">Dépenses prévues</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="monthly-expense-budget" class="form-control" placeholder="0">
                        <button class="btn btn-warning" id="auto-calc-expense" style="white-space: nowrap;">
                            <i class="fas fa-calculator"></i> Auto
                        </button>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <div style="font-weight: 600; margin-bottom: 10px; color: var(--primary-color);">
                    Budgets par catégorie
                </div>
                <div id="category-budgets-list">
                    <!-- Budgets par catégorie chargés dynamiquement -->
                </div>
                <button class="btn btn-primary" id="add-category-budget" style="width: 100%; margin-top: 15px;">
                    <i class="fas fa-plus"></i> Ajouter une catégorie
                </button>
            </div>
        </div>
        
        <div class="dashboard-card">
            <div class="card-header">
                <div class="card-title">Suivi du budget</div>
                <i class="fas fa-chart-line" style="color: var(--success-color); font-size: 24px;"></i>
            </div>
            
            <div style="margin-top: 20px;">
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Revenus actuels</span>
                        <span id="current-income">0</span>
                    </div>
                    <div class="card-progress">
                        <div class="progress-bar" id="income-progress" style="width: 0%; background: var(--success-color);"></div>
                    </div>
                    <div style="text-align: right; font-size: 12px; color: #6c757d; margin-top: 5px;">
                        Objectif: <span id="income-target">0</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Dépenses actuelles</span>
                        <span id="current-expense">0</span>
                    </div>
                    <div class="card-progress">
                        <div class="progress-bar" id="expense-progress" style="width: 0%; background: var(--danger-color);"></div>
                    </div>
                    <div style="text-align: right; font-size: 12px; color: #6c757d; margin-top: 5px;">
                        Budget: <span id="expense-target">0</span>
                    </div>
                </div>
                
                <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: var(--primary-color);">
                        Ajustements recommandés
                    </div>
                    <div id="budget-recommendations">
                        <!-- Recommandations chargées dynamiquement -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="dashboard-card">
            <div class="card-header">
                <div class="card-title">Projections</div>
                <i class="fas fa-chart-bar" style="color: var(--accent-color); font-size: 24px;"></i>
            </div>
            
            <div style="margin-top: 20px;">
                <div class="form-group">
                    <label for="projection-months">Projection sur (mois)</label>
                    <input type="range" id="projection-months" min="1" max="24" value="12" class="form-control" style="padding: 0;">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #6c757d;">
                        <span>1 mois</span>
                        <span id="projection-value">12 mois</span>
                        <span>24 mois</span>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: var(--primary-color);">
                        Projection d'épargne
                    </div>
                    <div id="savings-projection" style="height: 150px; display: flex; align-items: center; justify-content: center; color: #6c757d;">
                        <!-- Graphique de projection -->
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-weight: 600; color: #495057; margin-bottom: 10px;">
                        <i class="fas fa-lightbulb"></i> Conseil
                    </div>
                    <div id="budget-tip" style="font-size: 14px; color: #6c757d;">
                        <!-- Conseil personnalisé -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="dashboard-card" style="margin-top: 30px;">
        <div class="card-header">
            <div class="card-title">Historique des budgets</div>
            <i class="fas fa-history" style="color: var(--info-color); font-size: 24px;"></i>
        </div>
        
        <div style="margin-top: 20px;">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Mois</th>
                            <th>Revenus prévus</th>
                            <th>Revenus réels</th>
                            <th>Dépenses prévues</th>
                            <th>Dépenses réelles</th>
                            <th>Écart</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody id="budget-history-body">
                        <!-- Historique chargé dynamiquement -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
                
                <!-- Reports Tab -->
                <div class="tab-content" id="reports">
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Rapport mensuel</div>
                                <i class="fas fa-file-alt" style="color: var(--primary-color); font-size: 24px;"></i>
                            </div>
                            <div style="margin-top: 15px;">
                                <div style="margin-bottom: 10px;">
                                    <strong>Total entrées:</strong> <span id="monthly-income-total">0 FCFA</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>Total dépenses:</strong> <span id="monthly-expense-total">0 FCFA</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>Épargne accumulée:</strong> <span id="monthly-savings-total">0 FCFA</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>Investissement accumulé:</strong> <span id="monthly-investment-total">0 FCFA</span>
                                </div>
                                <div style="margin-top: 20px;">
                                    <button class="btn btn-primary" id="download-report-btn">
                                        <i class="fas fa-download"></i> Télécharger le rapport
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Statistiques</div>
                                <i class="fas fa-chart-pie" style="color: var(--accent-color); font-size: 24px;"></i>
                            </div>
                            <div style="margin-top: 15px;">
                                <div style="margin-bottom: 10px;">
                                    <strong>Top sources de revenus:</strong>
                                    <div id="top-income-sources">
                                        <!-- Les sources seront chargées dynamiquement -->
                                    </div>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>Catégories de dépenses:</strong>
                                    <div id="expense-categories">
                                        <!-- Les catégories seront chargées dynamiquement -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <div class="card-title">Objectifs</div>
                                <i class="fas fa-bullseye" style="color: var(--danger-color); font-size: 24px;"></i>
                            </div>
                            <div style="margin-top: 15px;">
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>Épargne mensuelle</span>
                                        <span id="savings-goal-progress">0%</span>
                                    </div>
                                    <div class="card-progress">
                                        <div class="progress-bar" id="savings-goal-bar" style="width: 0%;"></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>Investissement mensuel</span>
                                        <span id="investment-goal-progress">0%</span>
                                    </div>
                                    <div class="card-progress">
                                        <div class="progress-bar" id="investment-goal-bar" style="width: 0%;"></div>
                                    </div>
                                </div>
                                <div style="margin-top: 20px;">
                                    <button class="btn btn-primary" id="set-goals-btn">
                                        <i class="fas fa-edit"></i> Définir des objectifs
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="card-header">
                                <div class="card-title">Graphique des revenus et dépenses</div>
                                <i class="fas fa-chart-line" style="color: var(--secondary-color); font-size: 24px;"></i>
                            </div>
                            <div class="chart-container">
                                <canvas id="income-expense-chart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <div class="card-header">
                                <div class="card-title">Répartition des allocations</div>
                                <i class="fas fa-chart-pie" style="color: var(--primary-color); font-size: 24px;"></i>
                            </div>
                            <div class="chart-container">
                                <canvas id="allocation-pie-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- NOUVEL ONGLET RÉCOMPENSES -->
                <div class="tab-content" id="rewards">
    <!-- Bannière de niveau -->
    <div class="dashboard-card" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-size: 14px; opacity: 0.9;">Niveau</div>
                <div style="font-size: 36px; font-weight: 800; margin: 5px 0;">Niveau <span id="user-level">1</span></div>
                <div style="font-size: 14px;">Expérience: <span id="user-xp">0</span>/<span id="next-level-xp">100</span> XP</div>
            </div>
            
            <div style="text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;">Série quotidienne</div>
                <div style="font-size: 32px; font-weight: 800; margin: 5px 0;"><span id="daily-streak">0</span> 🔥</div>
                <div style="font-size: 14px;">jours consécutifs</div>
            </div>
            
            <div style="text-align: right;">
                <div style="font-size: 14px; opacity: 0.9;">Progression totale</div>
                <div style="font-size: 24px; font-weight: 800; margin: 5px 0;"><span id="total-badges">0</span>/<span id="total-possible-badges">22</span></div>
                <div style="font-size: 14px;">badges débloqués</div>
            </div>
        </div>
        
        <!-- Barre de progression -->
        <div style="margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px;">
                <span>Progression</span>
                <span id="level-progress">0%</span>
            </div>
            <div class="card-progress" style="background: rgba(255,255,255,0.2); height: 12px;">
                <div class="progress-bar" id="level-progress-bar" style="background: var(--accent-color); width: 0%;"></div>
            </div>
        </div>
    </div>
    
    <!-- Statistiques -->
    <div class="dashboard-grid" style="margin-top: 30px;">
        <div class="dashboard-card">
            <div class="card-header">
                <div class="card-title">Statistiques financières</div>
                <i class="fas fa-chart-bar" style="color: var(--success-color); font-size: 24px;"></i>
            </div>
            <div style="margin-top: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Transactions totales</span>
                    <span id="stats-transactions" style="font-weight: 600;">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Montant total alloué</span>
                    <span id="stats-allocated" style="font-weight: 600;">0 FCFA</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Dîmes envoyées</span>
                    <span id="stats-tithes" style="font-weight: 600;">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Aumônes totales</span>
                    <span id="stats-alms" style="font-weight: 600;">0 FCFA</span>
                </div>
            </div>
        </div>
        
        <div class="dashboard-card">
            <div class="card-header">
                <div class="card-title">Prochains badges</div>
                <i class="fas fa-trophy" style="color: var(--accent-color); font-size: 24px;"></i>
            </div>
            <div style="margin-top: 15px;" id="next-badges">
                <!-- Badges à débloquer chargés dynamiquement -->
                <div style="text-align: center; padding: 20px; color: #6c757d;">
                    <i class="fas fa-trophy" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i>
                    <div>Tous les badges sont débloqués !</div>
                </div>
            </div>
        </div>
        
        <div class="dashboard-card">
            <div class="card-header">
                <div class="card-title">Palmarès récent</div>
                <i class="fas fa-history" style="color: var(--info-color); font-size: 24px;"></i>
            </div>
            <div style="margin-top: 15px; max-height: 200px; overflow-y: auto;" id="recent-achievements">
                <!-- Derniers badges débloqués -->
                <div style="text-align: center; padding: 20px; color: #6c757d;">
                    <i class="fas fa-award" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i>
                    <div>Aucun badge débloqué récemment</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Collection de badges -->
    <div class="dashboard-card" style="margin-top: 30px;">
        <div class="card-header">
            <div class="card-title">Collection de badges</div>
            <div>
                <select id="badge-filter" class="form-control" style="width: auto; display: inline-block;">
                    <option value="all">Tous les badges</option>
                    <option value="unlocked">Débloqués</option>
                    <option value="locked">À débloquer</option>
                    <option value="general">Général</option>
                    <option value="money">Argent</option>
                    <option value="religious">Religieux</option>
                    <option value="charity">Charité</option>
                    <option value="savings">Épargne</option>
                    <option value="investment">Investissement</option>
                    <option value="activity">Activité</option>
                </select>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <div id="badges-collection" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px;">
                <!-- Tous les badges chargés dynamiquement -->
            </div>
        </div>
    </div>
    
    <!-- Défis du jour -->
    <div class="dashboard-card" style="margin-top: 30px;">
        <div class="card-header">
            <div class="card-title">Défis du jour</div>
            <i class="fas fa-calendar-day" style="color: var(--warning-color); font-size: 24px;"></i>
        </div>
        
        <div style="margin-top: 20px;">
            <div id="daily-challenges">
                <!-- Défis quotidiens chargés dynamiquement -->
                <div style="text-align: center; padding: 30px; color: #6c757d;">
                    <i class="fas fa-bullseye" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                    <div>Aucun défi disponible aujourd'hui</div>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="font-weight: 600; margin-bottom: 10px; color: #495057;">
                    <i class="fas fa-lightbulb"></i> Conseils pour gagner des badges
                </div>
                <div style="font-size: 14px; color: #6c757d; line-height: 1.5;">
                    1. <strong>Utilisez l'app quotidiennement</strong> pour maintenir votre série<br>
                    2. <strong>Respectez vos objectifs</strong> d'épargne et d'investissement<br>
                    3. <strong>Envoyez régulièrement</strong> vos dîmes et offrandes<br>
                    4. <strong>Catégorisez vos transactions</strong> pour mieux analyser<br>
                    5. <strong>Exportez vos données</strong> pour sécuriser vos finances
                </div>
            </div>
        </div>
    </div>
</div>

                <!-- Contacts Tab -->
                <div class="tab-content" id="contacts">
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-title">Statistiques par personne/source</div>
            <i class="fas fa-users" style="color: var(--primary-color); font-size: 24px;"></i>
        </div>
        
        <div class="tab-container" style="margin-bottom: 20px;">
            <div class="tab active" data-contact-type="all">Toutes</div>
            <div class="tab" data-contact-type="sources">Sources (entrées)</div>
            <div class="tab" data-contact-type="destinations">Destinations (sorties)</div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <input type="text" id="contact-search" class="form-control" placeholder="Rechercher une personne...">
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Personne/Source</th>
                        <th>Type</th>
                        <th>Total transactions</th>
                        <th>Montant total</th>
                        <th>Dernière transaction</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="contacts-body">
                    <!-- Rempli dynamiquement -->
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 30px;">
            <h4>Top 5 des sources d'entrées</h4>
            <div id="top-sources-chart" style="height: 200px;"></div>
        </div>
    </div>
</div>

                <!-- Converter Tab -->
                <div class="tab-content" id="converter">
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-title">Convertisseur de devises</div>
            <i class="fas fa-exchange-alt" style="color: var(--primary-color); font-size: 24px;"></i>
        </div>
        
        <div class="form-grid" style="margin-top: 20px;">
            <div class="form-group">
                <label for="convert-amount">Montant</label>
                <input type="number" id="convert-amount" class="form-control" placeholder="0" value="1000">
            </div>
            
            <div class="form-group">
                <label for="convert-from">De</label>
                <select id="convert-from" class="form-control">
                    <option value="FCFA">FCFA</option>
                    <option value="EUR">EUR (Euro)</option>
                    <option value="USD">USD (Dollar US)</option>
                    <option value="CAD">CAD (Dollar Canadien)</option>
                    <option value="CHF">CHF (Franc Suisse)</option>
                    <option value="GBP">GBP (Livre Sterling)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="convert-to">À</label>
                <select id="convert-to" class="form-control">
                    <option value="EUR">EUR (Euro)</option>
                    <option value="FCFA">FCFA</option>
                    <option value="USD">USD (Dollar US)</option>
                    <option value="CAD">CAD (Dollar Canadien)</option>
                    <option value="CHF">CHF (Franc Suisse)</option>
                    <option value="GBP">GBP (Livre Sterling)</option>
                </select>
            </div>
        </div>
        
        <div style="margin-top: 30px; text-align: center;">
            <button class="btn btn-primary" id="convert-btn">
                <i class="fas fa-sync-alt"></i> Convertir
            </button>
        </div>
        
        <div id="conversion-result" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; display: none;">
            <h3 style="text-align: center; color: var(--primary-color);" id="result-text"></h3>
            <div style="text-align: center; font-size: 14px; color: #666; margin-top: 10px;">
                <span id="rate-text"></span>
            </div>
        </div>
        
        <div style="margin-top: 40px;">
            <h4>Taux de change courants</h4>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Devise</th>
                            <th>Code</th>
                            <th>1 EUR =</th>
                            <th>1 USD =</th>
                        </tr>
                    </thead>
                    <tbody id="exchange-rates-body">
                        <!-- Rempli dynamiquement -->
                    </tbody>
                </table>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 10px;">
                <i class="fas fa-info-circle"></i> Les taux sont indicatifs et peuvent varier.
            </div>
        </div>
    </div>
</div>

                <!-- FAQ Tab -->
                <div class="tab-content" id="faq">
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-title">FAQ & Aide</div>
            <i class="fas fa-question-circle" style="color: var(--primary-color); font-size: 24px;"></i>
        </div>
        
        <div style="margin-top: 20px;">
            <div class="faq-search" style="margin-bottom: 30px;">
                <input type="text" id="faq-search" class="form-control" placeholder="Rechercher dans la FAQ...">
            </div>
            
            <div class="faq-categories">
                <div class="faq-category active" data-category="general">
                    <i class="fas fa-home"></i> Général
                </div>
                <div class="faq-category" data-category="transactions">
                    <i class="fas fa-exchange-alt"></i> Transactions
                </div>
                <div class="faq-category" data-category="accounts">
                    <i class="fas fa-wallet"></i> Comptes
                </div>
                <div class="faq-category" data-category="budgets">
                    <i class="fas fa-chart-pie"></i> Budgets
                </div>
                <div class="faq-category" data-category="technical">
                    <i class="fas fa-cogs"></i> Technique
                </div>
            </div>
            
            <div id="faq-questions" class="faq-questions">
                <!-- Questions réponses chargées dynamiquement -->
            </div>
            
            <div style="margin-top: 40px; padding: 20px; background: #fff9f0; border-radius: 10px;">
                <h4><i class="fas fa-life-ring"></i> Besoin d'aide supplémentaire ?</h4>
                <p>Si vous ne trouvez pas la réponse à votre question :</p>
                <ul>
                    <li>Consultez la documentation complète</li>
                    <li>Contactez l'administrateur de Ben Wallet</li>
                    <li>Signalez un bug via le menu Paramètres</li>
                </ul>
                <button class="btn btn-primary" id="contact-admin-btn">
                    <i class="fas fa-envelope"></i> Contacter l'administrateur
                </button>
            </div>
        </div>
    </div>
</div>

                
                <!-- Settings Tab -->
                <div class="tab-content" id="settings">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-title">Paramètres</div>
                            <i class="fas fa-cog" style="color: var(--primary-color); font-size: 24px;"></i>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <div style="font-weight: 700; margin-bottom: 20px; color: var(--primary-color);">
                                Paramètres d'allocation
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="tithe-percentage">Dîme (%)</label>
                                    <input type="number" id="tithe-percentage" class="form-control" value="10" min="0" max="100">
                                </div>
                                
                                <div class="form-group">
                                    <label for="offering-percentage">Offrande (%)</label>
                                    <input type="number" id="offering-percentage" class="form-control" value="5" min="0" max="100">
                                </div>
                                
                                <div class="form-group">
                                    <label for="builders-percentage">Bâtisseurs (%)</label>
                                    <input type="number" id="builders-percentage" class="form-control" value="10" min="0" max="100">
                                </div>
                                
                                <div class="form-group">
                                    <label for="alms-percentage">Aumône (%)</label>
                                    <input type="number" id="alms-percentage" class="form-control" value="5" min="0" max="100">
                                </div>
                                
                                <div class="form-group">
                                    <label for="savings-percentage">Épargne (%)</label>
                                    <input type="number" id="savings-percentage" class="form-control" value="15" min="0" max="100">
                                </div>
                                
                                <div class="form-group">
                                    <label for="investment-percentage">Investissement (%)</label>
                                    <input type="number" id="investment-percentage" class="form-control" value="15" min="0" max="100">
                                </div>
                                
                                <div class="form-group">
                                    <label for="available-percentage">Disponible (%)</label>
                                    <input type="number" id="available-percentage" class="form-control" value="40" min="0" max="100" readonly>
                                </div>
                            </div>
                            
                            <div style="margin-top: 30px;">
                                <div style="font-weight: 700; margin-bottom: 20px; color: var(--primary-color);">
                                    Objectifs mensuels
                                </div>
                                
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="monthly-savings-goal">Objectif d'épargne</label>
                                        <input type="number" id="monthly-savings-goal" class="form-control" value="50000">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="monthly-investment-goal">Objectif d'investissement</label>
                                        <input type="number" id="monthly-investment-goal" class="form-control" value="50000">
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 30px;">
                                <div style="font-weight: 700; margin-bottom: 20px; color: var(--primary-color);">
                                    Mon profil
                                </div>
                                
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="user-name-settings">Nom complet</label>
                                        <input type="text" id="user-name-settings" class="form-control" value="John Doe">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="user-status-settings">Statut dans la Famille Bên-Nâbîy</label>
                                        <select id="user-status-settings" class="form-control">
                                            <option value="aspirant">Aspirant (libre)</option>
                                            <option value="enfant">Enfant (15% : Dîme 10% + Offrande 5%)</option>
                                            <option value="fils" selected>Fils (30% : Dîme 10% + Offrande 5% + Bâtisseurs 10% + Aumônes 5%)</option>
                                            <option value="autre">Autre (personnalisé)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="user-currency-settings">Devise principale</label>
                                        <select id="user-currency-settings" class="form-control">
                                            <option value="FCFA" selected>FCFA (Franc CFA)</option>
                                            <option value="EUR">EUR (Euro)</option>
                                            <option value="USD">USD (Dollar US)</option>
                                            <option value="XAF">XAF (Franc CFA BEAC)</option>
                                            <option value="XOF">XOF (Franc CFA BCEAO)</option>
                                            <option value="CAD">CAD (Dollar Canadien)</option>
                                            <option value="CHF">CHF (Franc Suisse)</option>
                                            <option value="GBP">GBP (Livre Sterling)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="user-avatar-settings">Initiales pour avatar (2 lettres)</label>
                                        <input type="text" id="user-avatar-settings" class="form-control" maxlength="2" value="JD">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AJOUT: Sections de gestion des catégories personnalisées -->
                            <div style="margin-top: 40px;">
                                <div style="font-weight: 700; margin-bottom: 20px; color: var(--primary-color);">
                                    <i class="fas fa-tags"></i> Catégories personnalisées
                                </div>
                                
                                <div id="categories-list" style="margin-bottom: 25px;">
                                    <!-- Les catégories seront chargées dynamiquement ici -->
                                    <div style="text-align: center; padding: 20px; color: #6c757d; background: #f8f9fa; border-radius: 8px;">
                                        <i class="fas fa-tags" style="font-size: 24px; margin-bottom: 10px; display: block; opacity: 0.5;"></i>
                                        Vos catégories apparaîtront ici
                                    </div>
                                </div>
                                
                                <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; border: 2px dashed #dee2e6;">
                                    <div style="font-weight: 600; margin-bottom: 20px; color: #495057; font-size: 16px;">
                                        <i class="fas fa-plus-circle"></i> Ajouter une nouvelle catégorie
                                    </div>
                                    
                                    <div class="form-grid" style="grid-template-columns: 1fr 1fr 120px auto; gap: 15px;">
                                        <div class="form-group">
                                            <label for="new-category-name">Nom</label>
                                            <input type="text" id="new-category-name" class="form-control" placeholder="Ex: Loyer, Restaurant...">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="new-category-type">Type</label>
                                            <select id="new-category-type" class="form-control">
                                                <option value="income">Revenu</option>
                                                <option value="expense">Dépense</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="new-category-color">Couleur</label>
                                            <input type="color" id="new-category-color" class="form-control" value="#2E8B57" style="height: 42px; padding: 5px;">
                                        </div>
                                        
                                        <div class="form-group" style="align-self: flex-end;">
                                            <button class="btn btn-success" id="add-category-btn" style="width: 100%; height: 42px;">
                                                <i class="fas fa-plus"></i> Ajouter
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="margin-top: 40px; display: flex; gap: 15px; flex-wrap: wrap;">
                                <button class="btn btn-primary" id="save-settings-btn">
                                    <i class="fas fa-save"></i> Enregistrer les paramètres
                                </button>
                                <button class="btn btn-danger" id="reset-data-btn">
                                    <i class="fas fa-trash"></i> Réinitialiser toutes les données
                                </button>
                                <button class="btn btn-success" id="export-data-btn" onclick="FinancialApp.showExportModal()">
                                    <i class="fas fa-file-export"></i> Exporter les données
                                </button>
                                <button class="btn btn-warning" id="edit-profile-btn">
                                    <i class="fas fa-user-edit"></i> Modifier le profil
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Proof Modal -->
    <div class="modal" id="proof-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Preuve d'envoi</h3>
                <button class="close-modal" id="close-proof-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="proof-type">Type de preuve</label>
                    <select id="proof-type" class="form-control">
                        <option value="screenshot">Capture d'écran</option>
                        <option value="message">Message de confirmation</option>
                        <option value="receipt">Reçu</option>
                        <option value="other">Autre</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="proof-details">Détails / Message</label>
                    <textarea id="proof-details" class="form-control" rows="4" placeholder="Collez le message de confirmation ou décrivez la preuve..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="proof-date">Date d'envoi</label>
                    <input type="date" id="proof-date" class="form-control" value="">
                </div>
                
                <div class="form-group">
                    <label for="proof-time">Heure d'envoi</label>
                    <input type="time" id="proof-time" class="form-control" value="">
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-success" id="save-proof-btn">
                        <i class="fas fa-check"></i> Enregistrer la preuve
                    </button>
                    <button class="btn btn-danger" id="cancel-proof-btn">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transaction Details Modal -->
    <div class="modal" id="transaction-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="transaction-details-title">Détails de la transaction</h3>
                <button class="close-modal" id="close-transaction-modal">&times;</button>
            </div>
            <div class="modal-body" id="transaction-details-body">
                <!-- Les détails seront chargés dynamiquement -->
            </div>
        </div>
    </div>

            <!-- Export Modal -->
            <div class="modal" id="export-modal">
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-file-export"></i> Exporter les données</h3>
                        <button class="close-modal" id="close-export-modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr; margin-bottom: 25px;">
                            <div class="form-group">
                                <label for="export-type">Type d'export</label>
                                <select id="export-type" class="form-control">
                                    <option value="transactions">Transactions détaillées</option>
                                    <option value="allocations">Allocations (répartition)</option>
                                    <option value="full-report">Rapport complet</option>
                                    <option value="categories">Statistiques par catégorie</option>
                                </select>
                            </div>
                    
                            <div class="form-group">
                                <label for="export-period">Période</label>
                                <select id="export-period" class="form-control">
                                    <option value="current-month">Mois en cours</option>
                                    <option value="last-month">Mois précédent</option>
                                    <option value="current-year">Année en cours</option>
                                    <option value="custom">Personnalisée...</option>
                                </select>
                            </div>
                        </div>
                
                        <div id="custom-period-fields" style="display: none; margin-bottom: 25px;">
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                <div class="form-group">
                                    <label for="export-start-date">Date de début</label>
                                    <input type="date" id="export-start-date" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="export-end-date">Date de fin</label>
                                    <input type="date" id="export-end-date" class="form-control">
                                </div>
                            </div>
                        </div>
                
                        <div style="margin-bottom: 25px;">
                            <div style="font-weight: 600; margin-bottom: 10px; color: #555;">Options d'export</div>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="export-include-headers" checked style="cursor: pointer;">
                                    <span>Inclure les en-têtes</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="export-format-numbers" checked style="cursor: pointer;">
                                    <span>Formater les nombres (1,234.56)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="export-include-empty" checked style="cursor: pointer;">
                                    <span>Inclure les colonnes vides</span>
                                </label>
                            </div>
                        </div>
                
                        <div id="export-preview" style="margin-bottom: 25px;">
                            <div style="font-weight: 600; margin-bottom: 10px; color: #555;">Aperçu (10 premières lignes)</div>
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; border: 1px solid #dee2e6;">
                                <div id="preview-content" style="color: #6c757d;">Sélectionnez les options pour voir un aperçu...</div>
                            </div>
                        </div>
                
                        <div style="display: flex; gap: 15px; justify-content: flex-end;">
                            <button class="btn btn-secondary" id="preview-export-btn">
                                <i class="fas fa-eye"></i> Prévisualiser
                            </button>
                            <button class="btn btn-primary" id="generate-export-btn">
                                <i class="fas fa-file-csv"></i> Générer CSV
                            </button>
                            <button class="btn btn-success" id="generate-excel-btn">
                                <i class="fas fa-file-excel"></i> Générer Excel
                            </button>
                            <button class="btn btn-danger" id="cancel-export-btn">
                                <i class="fas fa-times"></i> Annuler
                            </button>
                        </div>
                    </div>
                </div>
            </div>

    <!-- Profile Creation Modal (apparaît au premier lancement) -->
    <div class="modal" id="profile-creation-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Créer votre compte Ben Wallet</h3>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 25px;">
                    <img src="android-chrome-512x512.png" alt="Ben Wallet" style="height: 80px; width: 80px; border-radius: 20px; border: 3px solid var(--accent-color); margin-bottom: 15px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 10px;">Bienvenue sur Ben Wallet</h3>
                    <p style="color: #6c757d;">Créez votre profil pour commencer à gérer vos finances intelligemment</p>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="user-name-create">Nom complet</label>
                        <input type="text" id="user-name-create" class="form-control" placeholder="Votre nom" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="user-status-create">Statut dans la Famille Bên-Nâbîy</label>
                        <select id="user-status-create" class="form-control">
                            <option value="aspirant">Aspirant (libre)</option>
                            <option value="enfant">Enfant (15% : Dîme 10% + Offrande 5%)</option>
                            <option value="fils" selected>Fils (30% : Dîme 10% + Offrande 5% + Bâtisseurs 10% + Aumônes 5%)</option>
                            <option value="autre">Autre (personnalisé)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="user-currency-create">Devise principale</label>
                        <select id="user-currency-create" class="form-control">
                            <option value="FCFA" selected>FCFA (Franc CFA)</option>
                            <option value="EUR">EUR (Euro)</option>
                            <option value="USD">USD (Dollar US)</option>
                            <option value="XAF">XAF (Franc CFA BEAC)</option>
                            <option value="XOF">XOF (Franc CFA BCEAO)</option>
                            <option value="CAD">CAD (Dollar Canadien)</option>
                            <option value="CHF">CHF (Franc Suisse)</option>
                            <option value="GBP">GBP (Livre Sterling)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="user-avatar-create">Initiales pour avatar (2 lettres)</label>
                        <input type="text" id="user-avatar-create" class="form-control" maxlength="2" placeholder="Ex: JD">
                    </div>
                    <div class="form-group">
                        <label for="user-profession">Profession (optionnel)</label>
                        <input type="text" id="user-profession" class="form-control" placeholder="Ex: Entrepreneur, Étudiant, etc.">
                    </div>

                    <div class="form-group">
                        <label for="user-email">Email (optionnel)</label>
                        <input type="email" id="user-email" class="form-control" placeholder="votre@email.com">
                    </div>

                    <div class="form-group">
                        <label for="user-phone">Téléphone (optionnel)</label>
                        <input type="tel" id="user-phone" class="form-control" placeholder="+225 XX XX XX XX">
                    </div>

                    <div class="form-group">
                        <label for="user-password">Mot de passe *</label>
                        <input type="password" id="user-password" class="form-control" placeholder="●●●●●●" required>
                        <small style="color: #666;">Minimum 4 caractères</small>
                    </div>

                    <div class="form-group">
                        <label for="user-confirm-password">Confirmer le mot de passe *</label>
                        <input type="password" id="user-confirm-password" class="form-control" placeholder="●●●●●●" required>
                    </div>
                </div>
                
                <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-success" id="create-profile-btn" style="padding: 15px 30px;" onclick="window.createUserProfile()">
                        <i class="fas fa-user-plus"></i> Créer mon compte
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Budget Modal (ajouté pour Budgets) -->
    <div class="modal" id="category-budget-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Ajouter un budget de catégorie</h3>
                <button class="close-modal" id="close-category-budget-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="budget-category-select">Catégorie</label>
                    <select id="budget-category-select" class="form-control">
                        <!-- Options chargées dynamiquement -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="category-budget-amount">Budget mensuel</label>
                    <input type="number" id="category-budget-amount" class="form-control" placeholder="Ex: 50000">
                </div>
                
                <div style="margin-top: 25px; display: flex; gap: 15px;">
                    <button class="btn btn-success" id="save-category-budget-btn">
                        <i class="fas fa-save"></i> Sauvegarder
                    </button>
                    <button class="btn btn-danger" id="cancel-category-budget-btn">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast container -->
    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <!-- Confirm modal (programmable) -->
    <div class="modal" id="confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirm-title">Confirmer</h3>
                <button class="close-modal" id="close-confirm-modal">&times;</button>
            </div>
            <div class="modal-body" id="confirm-body">
                <p id="confirm-message">Êtes-vous sûr ?</p>
                <div class="confirm-actions">
                    <button class="btn btn-secondary" id="confirm-cancel-btn">Annuler</button>
                    <button class="btn btn-danger" id="confirm-ok-btn">Confirmer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application principale
const FinancialApp = {
    // Vérification simple de session/login
    checkLogin() {
        const profile = localStorage.getItem('benWalletUserProfile');
        if (!profile) return false;
        try {
            const parsed = JSON.parse(profile);
            const lastLogin = parsed.lastLogin;
            if (!lastLogin) return false;
            const now = new Date();
            const last = new Date(lastLogin);
            const hoursDiff = (now - last) / (1000 * 60 * 60);
            if (hoursDiff < 24) return true;
        } catch (e) {
            return false;
        }
        return this.showLoginModal();
    },

    showLoginModal() {
        // Simple modal appended to body
        const modalHtml = `
        <div class="modal active" id="login-modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3>Connexion à Ben Wallet</h3>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="login-password">Mot de passe</label>
                        <input type="password" id="login-password" class="form-control" placeholder="●●●●●●">
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 15px;">
                        <button class="btn btn-success" id="login-btn">
                            <i class="fas fa-sign-in-alt"></i> Se connecter
                        </button>
                        <button class="btn btn-danger" id="logout-btn">
                            <i class="fas fa-sign-out-alt"></i> Déconnexion
                        </button>
                    </div>
                    <div style="margin-top: 20px; font-size: 14px; color: #666;">
                        <i class="fas fa-info-circle"></i> Mot de passe oublié ? Contactez l'administrateur.
                    </div>
                </div>
            </div>
        </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.getElementById('login-btn').addEventListener('click', () => this.login());
        document.getElementById('logout-btn').addEventListener('click', () => this.logout());
        return true;
    },

    login() {
        const password = document.getElementById('login-password')?.value || '';
        const profileRaw = localStorage.getItem('benWalletUserProfile');
        if (!profileRaw) { alert('Aucun profil trouvé'); return false; }
        const profile = JSON.parse(profileRaw);
        const hashed = btoa(unescape(encodeURIComponent(password)));
        if (profile.passwordHash && profile.passwordHash === hashed) {
            profile.lastLogin = new Date().toISOString();
            localStorage.setItem('benWalletUserProfile', JSON.stringify(profile));
            document.getElementById('login-modal')?.remove();
            this.init();
            return true;
        }
        alert('Mot de passe incorrect');
        return false;
    },

    logout() {
        localStorage.removeItem('benWalletUserProfile');
        localStorage.removeItem('benWalletData');
        window.location.reload();
    },
    // Initialisation
    init() {
        // Vérifier si l'utilisateur a un profil
        if (!this.checkUserProfile()) {
            this.showProfileCreationModal();
            return; // IMPORTANT : s'arrêter ici et ne pas continuer
        }

        // Si le profil existe, exiger une connexion si la dernière connexion date de plus de 24h
        try {
            const profileRaw = localStorage.getItem('benWalletUserProfile');
            if (profileRaw) {
                const profile = JSON.parse(profileRaw);
                const lastLogin = profile.lastLogin;
                if (!lastLogin) {
                    // Aucun enregistrement de connexion -> demander le mot de passe
                    this.showLoginModal();
                    return;
                }
                const hoursDiff = (new Date() - new Date(lastLogin)) / (1000 * 60 * 60);
                if (hoursDiff >= 24) {
                    // Plus de 24h depuis la dernière connexion -> afficher modal de login
                    this.showLoginModal();
                    return;
                }
            }
        } catch (err) {
            // En cas d'erreur, afficher le login par défaut
            this.showLoginModal();
            return;
        }

        // Charger les données et initialiser l'UI
        this.loadData();
        this.setupEventListeners();
        // Initialiser la gamification après chargement des données
        this.initGamification && this.initGamification();
        this.updateUI();
        this.setDefaultDate();

        this.checkPWAInstallation();
        this.initCharts();
    },
            
            // Vérifier l'installation PWA
            checkPWAInstallation() {
                if (window.matchMedia('(display-mode: standalone)').matches) {
                    console.log('Ben Wallet fonctionne en mode application installée');
                }
            },

            // Mettre à jour le dropdown des catégories dans le formulaire de transaction
            updateTransactionCategoryDropdown() {
                const select = document.getElementById('transaction-category');
                if (!select) return;

                const transactionTypeEl = document.getElementById('transaction-type');
                const transactionType = transactionTypeEl ? transactionTypeEl.value : 'income';

                const defaultOptions = [
                    { value: 'salary', text: 'Salaire' },
                    { value: 'gift', text: 'Cadeau' },
                    { value: 'business', text: 'Affaires' },
                    { value: 'other', text: 'Autre' }
                ];

                select.innerHTML = '';

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- Sélectionnez une catégorie --';
                defaultOption.disabled = true;
                defaultOption.selected = true;
                select.appendChild(defaultOption);

                const customCategories = (this.data.settings.customCategories || []).filter(cat => cat.type === transactionType);
                if (customCategories.length > 0) {
                    const group = document.createElement('optgroup');
                    group.label = 'Catégories personnalisées';
                    customCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = `custom_${category.id}`;
                        option.textContent = category.name;
                        option.style.color = category.color;
                        group.appendChild(option);
                    });
                    select.appendChild(group);
                }

                const defaultGroup = document.createElement('optgroup');
                defaultGroup.label = 'Catégories par défaut';
                defaultOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    defaultGroup.appendChild(option);
                });
                select.appendChild(defaultGroup);
            },
            
            // Vérifier le profil utilisateur
            checkUserProfile() {
                const profile = localStorage.getItem('benWalletUserProfile');
                return profile !== null;
            },
            
            // Afficher le modal de création de profil
            showProfileCreationModal() {
                document.getElementById('profile-creation-modal').classList.add('active');
                
                // Définir l'avatar par défaut
                const nameInput = document.getElementById('user-name-create');
                const avatarInput = document.getElementById('user-avatar-create');
                
                nameInput.addEventListener('input', () => {
                    if (nameInput.value.length >= 2 && !avatarInput.value) {
                        avatarInput.value = nameInput.value.substring(0, 2).toUpperCase();
                    }
                });
            },
            
            // Créer le profil utilisateur
            createUserProfile() {
                const userName = document.getElementById('user-name-create').value;
                const userStatus = document.getElementById('user-status-create').value;
                const userCurrency = document.getElementById('user-currency-create').value;
                let userAvatar = document.getElementById('user-avatar-create').value;
                
                if (!userName.trim()) {
                    alert('Veuillez entrer votre nom');
                    return;
                }
                
                if (!userAvatar) {
                    userAvatar = userName.substring(0, 2).toUpperCase();
                }
                
                // Récupérer mot de passe et validation
                const password = document.getElementById('user-password')?.value || '';
                const confirm = document.getElementById('user-confirm-password')?.value || '';
                const profession = document.getElementById('user-profession')?.value || '';
                const email = document.getElementById('user-email')?.value || '';
                const phone = document.getElementById('user-phone')?.value || '';

                if (!password || password.length < 4) {
                    alert('Veuillez créer un mot de passe d\'au moins 4 caractères');
                    return;
                }
                if (password !== confirm) {
                    alert('Les mots de passe ne correspondent pas');
                    return;
                }

                // Hacher le mot de passe (B64 pour démo)
                const hashedPassword = btoa(unescape(encodeURIComponent(password)));

                // Créer l'objet profil
                const userProfile = {
                    name: userName,
                    status: userStatus,
                    currency: userCurrency,
                    avatar: userAvatar,
                    profession: profession,
                    email: email,
                    phone: phone,
                    passwordHash: hashedPassword,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                };
                
                // Sauvegarder le profil
                localStorage.setItem('benWalletUserProfile', JSON.stringify(userProfile));
                
                // Initialiser les paramètres selon le statut
                this.initializeSettingsByStatus(userStatus);
                
                // Fermer le modal
                document.getElementById('profile-creation-modal').classList.remove('active');
                
                // Redémarrer l'application
                this.init();
            },
            
            // Initialiser les paramètres selon le statut
            initializeSettingsByStatus(status) {
                let defaultPercentages = {
                    tithePercent: 10,
                    offeringPercent: 5,
                    buildersPercent: 0,
                    almsPercent: 0,
                    savingsPercent: 15,
                    investmentPercent: 15,
                    availablePercent: 55
                };
                
                switch(status) {
                    case 'enfant':
                        defaultPercentages.buildersPercent = 0;
                        defaultPercentages.almsPercent = 0;
                        defaultPercentages.availablePercent = 55;
                        break;
                    case 'fils':
                        defaultPercentages.buildersPercent = 10;
                        defaultPercentages.almsPercent = 5;
                        defaultPercentages.availablePercent = 40;
                        break;
                    case 'aspirant':
                        // Libre - valeurs par défaut
                        break;
                    case 'autre':
                        // L'utilisateur définira ses propres pourcentages
                        break;
                }
                
                // Appliquer les pourcentages par défaut
                Object.assign(this.data.settings, defaultPercentages);
                this.saveData();
            },
            
            // Initialiser les graphiques
            initCharts() {
                // Graphique revenus/dépenses
                const incomeExpenseCtx = document.getElementById('income-expense-chart').getContext('2d');
                this.incomeExpenseChart = new Chart(incomeExpenseCtx, {
                    type: 'line',
                    data: {
                        labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                        datasets: [
                            {
                                label: 'Revenus',
                                data: [0, 0, 0, 0],
                                borderColor: 'var(--success-color)',
                                backgroundColor: 'rgba(46, 139, 87, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Dépenses',
                                data: [0, 0, 0, 0],
                                borderColor: 'var(--danger-color)',
                                backgroundColor: 'rgba(220, 20, 60, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => this.formatCurrency(value)
                                }
                            }
                        }
                    }
                });
                
                // Graphique en secteurs pour les allocations
                const allocationCtx = document.getElementById('allocation-pie-chart').getContext('2d');
                this.allocationChart = new Chart(allocationCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Dîme', 'Offrande', 'Bâtisseurs', 'Aumône', 'Épargne', 'Investissement', 'Disponible'],
                        datasets: [{
                            data: [0, 0, 0, 0, 0, 0, 0],
                            backgroundColor: [
                                'var(--danger-color)',
                                'var(--warning-color)',
                                'var(--info-color)',
                                '#9b59b6',
                                'var(--success-color)',
                                'var(--accent-dark)',
                                'var(--primary-color)'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        return `${label}: ${this.formatCurrency(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            },
            
            // Mettre à jour les graphiques
            updateCharts() {
                // Mettre à jour le graphique revenus/dépenses
                const month = parseInt(document.getElementById('month-select').value);
                const year = parseInt(document.getElementById('year-select').value);
                
                // Données par semaine (simplifié)
                const weeklyData = { income: [0, 0, 0, 0], expense: [0, 0, 0, 0] };
                
                this.data.transactions.forEach(transaction => {
                    const transactionDate = new Date(transaction.date);
                    if (transactionDate.getMonth() + 1 === month && transactionDate.getFullYear() === year) {
                        const week = Math.min(3, Math.floor((transactionDate.getDate() - 1) / 7));
                        
                        if (transaction.type === 'income') {
                            weeklyData.income[week] += transaction.amount;
                        } else {
                            weeklyData.expense[week] += transaction.amount;
                        }
                    }
                });
                
                this.incomeExpenseChart.data.datasets[0].data = weeklyData.income;
                this.incomeExpenseChart.data.datasets[1].data = weeklyData.expense;
                this.incomeExpenseChart.update();
                
                // Mettre à jour le graphique en secteurs
                const allocationData = [
                    this.data.accounts.tithe.balance,
                    this.data.accounts.offering.balance,
                    this.data.accounts.builders.balance,
                    this.data.accounts.alms.balance,
                    this.data.accounts.savings.balance,
                    this.data.accounts.investment.balance,
                    this.data.accounts.available.balance
                ];
                
                this.allocationChart.data.datasets[0].data = allocationData;
                this.allocationChart.update();
            },
            
            // Données
            data: {
                settings: {
                    tithePercent: 10,
                    offeringPercent: 5,
                    buildersPercent: 10,
                    almsPercent: 5,
                    savingsPercent: 15,
                    investmentPercent: 15,
                    availablePercent: 40,
                    monthlySavingsGoal: 50000,
                        monthlyInvestmentGoal: 50000,
                        // Catégories personnalisées (utilisateur)
                        customCategories: [
                            { id: 1, name: "Salaire", type: "income", color: "#2E8B57" },
                            { id: 2, name: "Cadeau", type: "income", color: "#4169E1" },
                            { id: 3, name: "Affaires", type: "income", color: "#9b59b6" },
                            { id: 4, name: "Autre revenu", type: "income", color: "#FF8C00" },
                            { id: 5, name: "Alimentation", type: "expense", color: "#DC143C" },
                            { id: 6, name: "Transport", type: "expense", color: "#1E90FF" },
                            { id: 7, name: "Loisirs", type: "expense", color: "#FF69B4" },
                            { id: 8, name: "Santé", type: "expense", color: "#32CD32" }
                        ]
                    ,
                    // Budgets et alertes
                    budgets: {
                        monthly: {
                            income: 0,
                            expense: 0,
                            savings: 0,
                            investment: 0,
                            categories: {} // Ex: { "Alimentation": 50000 }
                        },
                        annual: {
                            income: 0,
                            expense: 0,
                            savings: 0,
                            investment: 0
                        }
                    },
                    budgetAlerts: {
                        enabled: true,
                        threshold: 80,
                        notifyByEmail: false,
                        notifyInApp: true
                    }
                },
                transactions: [],
                people: {},
                budgetHistory: [],
                accounts: {
                    tithe: { balance: 0, sent: false, sentDate: null, sentTime: null, proof: null },
                    offering: { balance: 0, sent: false, sentDate: null, sentTime: null, proof: null },
                    builders: { balance: 0, sent: false, sentDate: null, sentTime: null, proof: null },
                    alms: { balance: 0, sent: false, sentDate: null, sentTime: null, proof: null },
                    savings: { balance: 0, lastTransaction: null, startDate: null },
                    investment: { balance: 0, lastTransaction: null, startDate: null },
                    available: { balance: 0, lastTransaction: null }
                },
                allocationsHistory: [],
                currentAllocation: null,
                currentProofAccount: null
                ,
                // Gamification / Achievements
                achievements: {
                    badges: [],
                    milestones: {
                        firstTransaction: false,
                        first10000: false,
                        first50000: false,
                        first100000: false,
                        firstAllocation: false,
                        titheStreak: 0,
                        offeringStreak: 0,
                        savingsGoalReached: 0,
                        investmentGoalReached: 0,
                        daysActive: 0,
                        transactionsCount: 0,
                        totalAllocated: 0,
                        totalDonated: 0
                    },
                    level: 1,
                    experience: 0,
                    nextLevelXP: 100,
                    unlockedAchievements: [],
                    dailyStreak: 0,
                    lastActivity: null
                },
                badgesList: [
                    { id: 'first_transaction', name: 'Premier pas', description: 'Effectué votre première transaction', icon: 'fas fa-star', color: '#FFD700', xp: 10, category: 'general' },
                    { id: 'first_10000', name: 'Apprenti financier', description: 'Atteint 10,000 FCFA en transactions', icon: 'fas fa-coins', color: '#C0C0C0', xp: 25, category: 'money' },
                    { id: 'first_50000', name: 'Financier confirmé', description: 'Atteint 50,000 FCFA en transactions', icon: 'fas fa-money-bill-wave', color: '#FFD700', xp: 50, category: 'money' },
                    { id: 'first_100000', name: 'Maître des finances', description: 'Atteint 100,000 FCFA en transactions', icon: 'fas fa-crown', color: '#FF6B6B', xp: 100, category: 'money' },
                    { id: 'first_allocation', name: 'Bons comptes', description: 'Effectué votre première allocation automatique', icon: 'fas fa-hand-holding-usd', color: '#4ECDC4', xp: 20, category: 'allocation' },
                    { id: 'tithe_7', name: 'Dîme fidèle', description: 'Envoyé 7 dîmes consécutives', icon: 'fas fa-church', color: '#95E1D3', xp: 30, category: 'religious' },
                    { id: 'tithe_30', name: 'Dîme exemplaire', description: 'Envoyé 30 dîmes consécutives', icon: 'fas fa-pray', color: '#F38181', xp: 100, category: 'religious' },
                    { id: 'offering_7', name: 'Généreux', description: 'Envoyé 7 offrandes consécutives', icon: 'fas fa-hands-helping', color: '#FFD166', xp: 25, category: 'religious' },
                    { id: 'alms_2000', name: 'Assistant social', description: 'Totalisé 2,000 FCFA en aumônes', icon: 'fas fa-hand-holding-heart', color: '#06D6A0', xp: 40, category: 'charity' },
                    { id: 'alms_10000', name: 'Bienfaiteur', description: 'Totalisé 10,000 FCFA en aumônes', icon: 'fas fa-hands', color: '#118AB2', xp: 80, category: 'charity' },
                    { id: 'savings_goal', name: 'Épargnant', description: 'Atteint votre objectif d\'épargne mensuel', icon: 'fas fa-piggy-bank', color: '#83C5BE', xp: 35, category: 'savings' },
                    { id: 'savings_goal_3', name: 'Épargnant sérieux', description: 'Atteint votre objectif d\'épargne 3 mois de suite', icon: 'fas fa-university', color: '#006D77', xp: 75, category: 'savings' },
                    { id: 'investment_goal', name: 'Investisseur', description: 'Atteint votre objectif d\'investissement mensuel', icon: 'fas fa-chart-line', color: '#E29578', xp: 40, category: 'investment' },
                    { id: 'budget_expert', name: 'Maître du budget', description: 'Respecté votre budget mensuel', icon: 'fas fa-chart-pie', color: '#FFDDD2', xp: 30, category: 'budget' },
                    { id: 'transaction_10', name: 'Actif', description: 'Effectué 10 transactions', icon: 'fas fa-exchange-alt', color: '#E8E8E8', xp: 15, category: 'activity' },
                    { id: 'transaction_50', name: 'Très actif', description: 'Effectué 50 transactions', icon: 'fas fa-bolt', color: '#FF9E00', xp: 50, category: 'activity' },
                    { id: 'daily_7', name: 'Assidu', description: 'Utilisé l\'app 7 jours consécutifs', icon: 'fas fa-calendar-check', color: '#4CC9F0', xp: 25, category: 'activity' },
                    { id: 'daily_30', name: 'Fidèle', description: 'Utilisé l\'app 30 jours consécutifs', icon: 'fas fa-calendar-star', color: '#F72585', xp: 100, category: 'activity' },
                    { id: 'allocation_total_100000', name: 'Bons comptes', description: 'Total alloué atteint 100,000 FCFA', icon: 'fas fa-balance-scale', color: '#7209B7', xp: 60, category: 'allocation' },
                    { id: 'category_master', name: 'Organisé', description: 'Créé 5 catégories personnalisées', icon: 'fas fa-tags', color: '#3A86FF', xp: 20, category: 'organization' },
                    { id: 'export_master', name: 'Archiviste', description: 'Exporté vos données 3 fois', icon: 'fas fa-file-export', color: '#FB5607', xp: 25, category: 'organization' }
                ]
            },
            
            // Charger les données depuis localStorage
            loadData() {
                const savedData = localStorage.getItem('benWalletData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    // Migration-safe merge: ensure nested objects like settings and budgets are preserved
                    this.data = { ...this.data, ...parsedData };
                    if (!this.data.settings) this.data.settings = parsedData.settings || this.data.settings;
                    // Ensure budgets exist
                    if (!this.data.settings.budgets) {
                        this.data.settings.budgets = {
                            monthly: { income: 0, expense: 0, savings: 0, investment: 0, categories: {} },
                            annual: { income: 0, expense: 0, savings: 0, investment: 0 }
                        };
                    }
                    if (!this.data.settings.budgetAlerts) {
                        this.data.settings.budgetAlerts = { enabled: true, threshold: 80, notifyByEmail: false, notifyInApp: true };
                    }
                }
                
                // Initialiser les dates si elles sont nulles
                const today = new Date().toISOString().split('T')[0];
                if (!this.data.accounts.savings.startDate) {
                    this.data.accounts.savings.startDate = today;
                }
                if (!this.data.accounts.investment.startDate) {
                    this.data.accounts.investment.startDate = today;
                }
            },
            
            // Sauvegarder les données dans localStorage
            saveData() {
                localStorage.setItem('benWalletData', JSON.stringify(this.data));
            },

            // Suivi des personnes/sources/destinataires
            trackPerson(name, amount, type, transactionId) {
                if (!name) return;
                const cleanName = name.trim();
                const key = cleanName.toLowerCase().replace(/\s+/g, '_');
                if (!this.data.people) this.data.people = {};
                if (!this.data.people[key]) {
                    this.data.people[key] = {
                        id: key,
                        name: cleanName,
                        type: type,
                        totalAmount: 0,
                        transactionCount: 0,
                        firstTransaction: new Date().toISOString(),
                        lastTransaction: new Date().toISOString(),
                        transactions: []
                    };
                }
                const p = this.data.people[key];
                p.totalAmount = (p.totalAmount || 0) + (amount || 0);
                p.transactionCount = (p.transactionCount || 0) + 1;
                p.lastTransaction = new Date().toISOString();
                p.transactions.unshift({ id: transactionId, amount, type, date: new Date().toISOString() });
                if (p.transactions.length > 50) p.transactions.pop();
                this.saveData();
            },

            // Enregistrer un enregistrement historique de budget
            recordBudgetHistory(month, category, budgeted, actual) {
                if (!this.data.budgetHistory) this.data.budgetHistory = [];
                const id = `${month}_${category}`;
                const status = (actual || 0) <= (budgeted || 0) ? 'under' : 'over';
                const difference = (budgeted || 0) - (actual || 0);
                const existingIndex = this.data.budgetHistory.findIndex(b => b.id === id);
                const record = { id, month, category, budgeted: budgeted || 0, actual: actual || 0, difference, status, updatedAt: new Date().toISOString() };
                if (existingIndex > -1) this.data.budgetHistory[existingIndex] = record;
                else this.data.budgetHistory.push(record);
                this.saveData();
            },

            // ========== MÉTHODES GAMIFICATION ==========

            // Initialiser la gamification
            initGamification() {
                // Vérifier la série quotidienne
                this.checkDailyStreak();
                
                // Vérifier les nouveaux badges
                this.checkForNewBadges();
                
                // Mettre à jour l'interface
                this.updateGamificationUI();
                this.renderBadgesCollection();
                this.loadDailyChallenges && this.loadDailyChallenges();
                
                // Vérifier les statistiques
                this.updateAchievementStats && this.updateAchievementStats();
            },

            // Vérifier la série quotidienne
            checkDailyStreak() {
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const lastActivity = this.data.achievements.lastActivity;
                
                if (!lastActivity) {
                    // Première connexion
                    this.data.achievements.dailyStreak = 1;
                } else {
                    const lastDate = new Date(lastActivity);
                    const yesterday = new Date(now);
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    // Vérifier si c'est le même jour
                    if (lastDate.toISOString().split('T')[0] === today) {
                        // Déjà connecté aujourd'hui
                        return;
                    }
                    
                    // Vérifier si c'était hier (série maintenue)
                    if (lastDate.toISOString().split('T')[0] === yesterday.toISOString().split('T')[0]) {
                        this.data.achievements.dailyStreak++;
                        
                        // Badge pour série de 7 jours
                        if (this.data.achievements.dailyStreak === 7) {
                            this.unlockBadge('daily_7');
                        }
                        
                        // Badge pour série de 30 jours
                        if (this.data.achievements.dailyStreak === 30) {
                            this.unlockBadge('daily_30');
                        }
                    } else {
                        // Série rompue
                        this.data.achievements.dailyStreak = 1;
                    }
                }
                
                // Mettre à jour la date de dernière activité
                this.data.achievements.lastActivity = now.toISOString();
                this.saveData();
            },

            // Vérifier les nouveaux badges
            checkForNewBadges() {
                // Compter les transactions
                const transactionCount = this.data.transactions.length;
                this.data.achievements.milestones.transactionsCount = transactionCount;
                
                // Badge première transaction
                if (transactionCount > 0 && !this.data.achievements.milestones.firstTransaction) {
                    this.unlockBadge('first_transaction');
                    this.data.achievements.milestones.firstTransaction = true;
                }
                
                // Badge 10 transactions
                if (transactionCount >= 10 && !this.hasBadge('transaction_10')) {
                    this.unlockBadge('transaction_10');
                }
                
                // Badge 50 transactions
                if (transactionCount >= 50 && !this.hasBadge('transaction_50')) {
                    this.unlockBadge('transaction_50');
                }
                
                // Calculer le montant total des transactions
                const totalAmount = this.data.transactions.reduce((sum, t) => sum + (t.amount || 0), 0);
                
                // Badge 10,000 FCFA
                if (totalAmount >= 10000 && !this.data.achievements.milestones.first10000) {
                    this.unlockBadge('first_10000');
                    this.data.achievements.milestones.first10000 = true;
                }
                
                // Badge 50,000 FCFA
                if (totalAmount >= 50000 && !this.data.achievements.milestones.first50000) {
                    this.unlockBadge('first_50000');
                    this.data.achievements.milestones.first50000 = true;
                }
                
                // Badge 100,000 FCFA
                if (totalAmount >= 100000 && !this.data.achievements.milestones.first100000) {
                    this.unlockBadge('first_100000');
                    this.data.achievements.milestones.first100000 = true;
                }
                
                // Vérifier les allocations
                const hasAllocations = this.data.transactions.some(t => t.allocated);
                if (hasAllocations && !this.data.achievements.milestones.firstAllocation) {
                    this.unlockBadge('first_allocation');
                    this.data.achievements.milestones.firstAllocation = true;
                }
                
                // Calculer le total alloué
                const totalAllocated = (this.data.allocationsHistory || []).reduce((sum, a) => sum + (a.amount || 0), 0);
                this.data.achievements.milestones.totalAllocated = totalAllocated;
                
                // Badge 100,000 FCFA alloué
                if (totalAllocated >= 100000 && !this.hasBadge('allocation_total_100000')) {
                    this.unlockBadge('allocation_total_100000');
                }
                
                // Vérifier les dîmes (approximation)
                const titheCount = (this.data.accounts.tithe.sent ? 1 : 0) + (this.data.achievements.milestones.titheStreak || 0);
                this.data.achievements.milestones.titheStreak = titheCount;
                
                if (titheCount >= 7 && !this.hasBadge('tithe_7')) {
                    this.unlockBadge('tithe_7');
                }
                if (titheCount >= 30 && !this.hasBadge('tithe_30')) {
                    this.unlockBadge('tithe_30');
                }
                
                // Vérifier les aumônes
                const totalAlms = (this.data.accounts.alms.balance || 0) + ((this.data.accounts.alms.sent ? 1000 : 0));
                this.data.achievements.milestones.totalDonated = totalAlms;
                
                if (totalAlms >= 2000 && !this.hasBadge('alms_2000')) {
                    this.unlockBadge('alms_2000');
                }
                if (totalAlms >= 10000 && !this.hasBadge('alms_10000')) {
                    this.unlockBadge('alms_10000');
                }
                
                // Épargne
                const currentSavings = this.data.accounts.savings.balance || 0;
                const savingsGoal = this.data.settings.monthlySavingsGoal || 0;
                if (savingsGoal > 0 && currentSavings >= savingsGoal) {
                    this.data.achievements.milestones.savingsGoalReached = (this.data.achievements.milestones.savingsGoalReached || 0) + 1;
                    if (!this.hasBadge('savings_goal')) this.unlockBadge('savings_goal');
                    if (this.data.achievements.milestones.savingsGoalReached >= 3 && !this.hasBadge('savings_goal_3')) this.unlockBadge('savings_goal_3');
                }
                
                // Catégories personnalisées
                const customCategoriesCount = (this.data.settings.customCategories || []).length;
                if (customCategoriesCount >= 5 && !this.hasBadge('category_master')) {
                    this.unlockBadge('category_master');
                }
                
                this.saveData();
            },

            // Débloquer un badge
            unlockBadge(badgeId) {
                if (this.hasBadge(badgeId)) return;
                const badge = (this.data.badgesList || []).find(b => b.id === badgeId);
                if (!badge) return;

                this.data.achievements.badges.push({ id: badgeId, unlockedAt: new Date().toISOString(), xp: badge.xp });
                this.data.achievements.unlockedAchievements.unshift({ id: badgeId, name: badge.name, description: badge.description, icon: badge.icon, color: badge.color, unlockedAt: new Date().toISOString() });
                if (this.data.achievements.unlockedAchievements.length > 10) this.data.achievements.unlockedAchievements.pop();
                this.addXP(badge.xp);
                this.showAchievementNotification(badge);
                this.saveData();
                this.updateNewBadgesCount && this.updateNewBadgesCount();
            },

            // Vérifier si un badge existe
            hasBadge(badgeId) {
                return (this.data.achievements.badges || []).some(b => b.id === badgeId);
            },

            // Ajouter de l'XP
            addXP(amount) {
                this.data.achievements.experience = (this.data.achievements.experience || 0) + amount;
                while (this.data.achievements.experience >= this.data.achievements.nextLevelXP) {
                    this.data.achievements.level++;
                    this.data.achievements.experience -= this.data.achievements.nextLevelXP;
                    this.data.achievements.nextLevelXP = Math.floor(this.data.achievements.nextLevelXP * 1.5);
                    this.showLevelUpNotification();
                }
                this.saveData();
                this.updateGamificationUI && this.updateGamificationUI();
            },

            // Notifications visuelles pour badge
            showAchievementNotification(badge) {
                const notificationEl = document.createElement('div');
                notificationEl.className = 'achievement-notification';
                notificationEl.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 20px;
                    background: white;
                    border-radius: 12px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                    z-index: 9999;
                    min-width: 350px;
                    border-left: 6px solid ${badge.color};
                    animation: slideInRight 0.5s ease-out;
                    display: flex;
                    align-items: center;
                    gap: 15px;
                `;
                notificationEl.innerHTML = `
                    <div style="font-size: 36px; color: ${badge.color};">
                        <i class="${badge.icon}"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">NOUVEAU BADGE DÉBLOQUÉ!</div>
                        <div style="font-weight: 800; font-size: 18px; color: #343a40; margin-bottom: 5px;">${badge.name}</div>
                        <div style="font-size: 14px; color: #6c757d;">${badge.description}</div>
                        <div style="margin-top: 10px; font-size: 12px; color: ${badge.color}; font-weight: 600;">
                            <i class="fas fa-star"></i> +${badge.xp} XP
                        </div>
                    </div>
                    <button class="close-achievement" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #6c757d;">
                        &times;
                    </button>
                `;
                document.body.appendChild(notificationEl);
                setTimeout(() => {
                    notificationEl.style.animation = 'slideOutRight 0.5s ease-out';
                    setTimeout(() => notificationEl.remove(), 500);
                }, 5000);
                notificationEl.querySelector('.close-achievement').addEventListener('click', () => {
                    notificationEl.style.animation = 'slideOutRight 0.5s ease-out';
                    setTimeout(() => notificationEl.remove(), 500);
                });
            },

            // Notification niveau
            showLevelUpNotification() {
                const notificationEl = document.createElement('div');
                notificationEl.className = 'level-up-notification';
                notificationEl.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    padding: 30px;
                    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
                    color: white;
                    border-radius: 20px;
                    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
                    z-index: 10000;
                    text-align: center;
                    min-width: 400px;
                    animation: levelUpPop 0.8s ease-out;
                `;
                notificationEl.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 15px;">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div style="font-size: 24px; font-weight: 800; margin-bottom: 10px;">
                        NIVEAU ${this.data.achievements.level} ATTEINT!
                    </div>
                    <div style="font-size: 16px; opacity: 0.9; margin-bottom: 20px;">
                        Félicitations! Vous progressez dans votre aventure financière.
                    </div>
                    <button class="close-level-up" style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 10px 30px; border-radius: 50px; font-weight: 600; cursor: pointer;">
                        SUPER!
                    </button>
                `;
                document.body.appendChild(notificationEl);
                notificationEl.querySelector('.close-level-up').addEventListener('click', () => {
                    notificationEl.style.animation = 'fadeOut 0.5s ease-out';
                    setTimeout(() => notificationEl.remove(), 500);
                });
            },

            // Mettre à jour l'UI de gamification
            updateGamificationUI() {
                const a = this.data.achievements || {};
                document.getElementById('user-level') && (document.getElementById('user-level').textContent = a.level || 1);
                document.getElementById('user-xp') && (document.getElementById('user-xp').textContent = a.experience || 0);
                document.getElementById('next-level-xp') && (document.getElementById('next-level-xp').textContent = a.nextLevelXP || 100);
                document.getElementById('daily-streak') && (document.getElementById('daily-streak').textContent = a.dailyStreak || 0);
                const unlockedBadges = (a.badges || []).length;
                document.getElementById('total-badges') && (document.getElementById('total-badges').textContent = unlockedBadges);
                document.getElementById('total-possible-badges') && (document.getElementById('total-possible-badges').textContent = (this.data.badgesList || []).length);
                const progressPercent = ((a.experience || 0) / (a.nextLevelXP || 100)) * 100;
                document.getElementById('level-progress') && (document.getElementById('level-progress').textContent = `${(progressPercent || 0).toFixed(1)}%`);
                document.getElementById('level-progress-bar') && (document.getElementById('level-progress-bar').style.width = `${progressPercent || 0}%`);
                this.renderNextBadges && this.renderNextBadges();
                this.renderRecentAchievements && this.renderRecentAchievements();
            },

            // Rendu de la collection de badges
            renderBadgesCollection() {
                const container = document.getElementById('badges-collection');
                if (!container) return;
                container.innerHTML = '';
                const filter = document.getElementById('badge-filter')?.value || 'all';
                (this.data.badgesList || []).forEach(badge => {
                    const isUnlocked = this.hasBadge(badge.id);
                    if (filter === 'unlocked' && !isUnlocked) return;
                    if (filter === 'locked' && isUnlocked) return;
                    if (filter !== 'all' && filter !== 'unlocked' && filter !== 'locked' && badge.category !== filter) return;
                    const badgeEl = document.createElement('div');
                    badgeEl.className = 'badge-item';
                    badgeEl.style.cssText = `
                        text-align: center;
                        padding: 20px 10px;
                        background: white;
                        border-radius: 12px;
                        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
                        transition: all 0.3s;
                        opacity: ${isUnlocked ? '1' : '0.5'};
                        position: relative;
                        border: 2px solid ${isUnlocked ? badge.color : '#e9ecef'};
                    `;
                    badgeEl.innerHTML = `
                        <div style="font-size: 36px; color: ${isUnlocked ? badge.color : '#adb5bd'}; margin-bottom: 10px;">
                            <i class="${badge.icon}"></i>
                        </div>
                        <div style="font-weight: 700; color: #343a40; margin-bottom: 5px; font-size: 14px;">${badge.name}</div>
                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 10px; min-height: 36px;">${badge.description}</div>
                        <div style="font-size: 11px; color: ${isUnlocked ? badge.color : '#adb5bd'}; font-weight: 600;"><i class="fas fa-star"></i> ${badge.xp} XP</div>
                        ${isUnlocked ? `<div style="position: absolute; top: 10px; right: 10px; color: ${badge.color};"><i class="fas fa-check-circle"></i></div>` : `<div style="position: absolute; top: 10px; right: 10px; color: #adb5bd;"><i class="fas fa-lock"></i></div>`}
                    `;
                    badgeEl.onmouseover = () => { if (isUnlocked) { badgeEl.style.transform = 'translateY(-5px)'; badgeEl.style.boxShadow = '0 10px 25px rgba(0,0,0,0.15)'; } };
                    badgeEl.onmouseout = () => { badgeEl.style.transform = ''; badgeEl.style.boxShadow = '0 5px 15px rgba(0,0,0,0.08)'; };
                    container.appendChild(badgeEl);
                });
            },

            renderNextBadges() {
                const container = document.getElementById('next-badges');
                if (!container) return;
                const unlocked = (this.data.achievements.badges || []).map(b => b.id);
                const next = (this.data.badgesList || []).filter(b => !unlocked.includes(b.id)).slice(0,3);
                if (next.length === 0) {
                    container.innerHTML = `<div style="text-align: center; padding: 20px; color: #6c757d;"><i class="fas fa-trophy" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i><div>Tous les badges sont débloqués !</div></div>`;
                    return;
                }
                container.innerHTML = '';
                next.forEach(b => {
                    const el = document.createElement('div');
                    el.style.cssText = 'display:flex; align-items:center; gap:12px; padding:10px; border-bottom:1px solid #eee;';
                    el.innerHTML = `<div style="font-size:20px; color:${b.color}; width:48px; text-align:center;"><i class="${b.icon}"></i></div><div><div style="font-weight:700">${b.name}</div><div style="font-size:12px; color:#6c757d">${b.description}</div></div>`;
                    container.appendChild(el);
                });
            },

            renderRecentAchievements() {
                const container = document.getElementById('recent-achievements');
                if (!container) return;
                const recent = (this.data.achievements.unlockedAchievements || []).slice(0,10);
                if (recent.length === 0) {
                    container.innerHTML = `<div style="text-align: center; padding: 20px; color: #6c757d;"><i class="fas fa-award" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i><div>Aucun badge débloqué récemment</div></div>`;
                    return;
                }
                container.innerHTML = '';
                recent.forEach(r => {
                    const el = document.createElement('div');
                    el.style.cssText = 'display:flex; align-items:center; gap:12px; padding:8px; border-bottom:1px solid #eee;';
                    el.innerHTML = `<div style="font-size:20px; color:${r.color}; width:48px; text-align:center;"><i class="${r.icon}"></i></div><div><div style="font-weight:700">${r.name}</div><div style="font-size:12px; color:#6c757d">${new Date(r.unlockedAt).toLocaleString()}</div></div>`;
                    container.appendChild(el);
                });
            },

            // Charger les contacts/personnes
            loadContacts() {
                const tbody = document.getElementById('contacts-body');
                if (!tbody) return;
                tbody.innerHTML = '';

                const searchTerm = document.getElementById('contact-search')?.value.toLowerCase() || '';
                const activeType = document.querySelector('[data-contact-type].active')?.getAttribute('data-contact-type') || 'all';

                Object.values(this.data.people || {}).forEach(person => {
                    if (activeType === 'sources' && person.type !== 'income') return;
                    if (activeType === 'destinations' && person.type !== 'expense') return;
                    if (searchTerm && !person.name.toLowerCase().includes(searchTerm)) return;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${person.name}</strong></td>
                        <td><span class="transaction-type ${person.type === 'income' ? 'type-income' : 'type-expense'}">${person.type === 'income' ? 'Source' : 'Destination'}</span></td>
                        <td>${person.transactionCount || 0}</td>
                        <td>${this.formatCurrency(person.totalAmount || 0)}</td>
                        <td>${this.formatDateWithTime(person.lastTransaction || '')}</td>
                        <td><button class="btn btn-primary btn-sm" onclick="FinancialApp.viewPersonDetails('${person.id}')"><i class="fas fa-eye"></i> Détails</button></td>
                    `;
                    tbody.appendChild(row);
                });
            },

            viewPersonDetails(personId) {
                const person = this.data.people[personId];
                if (!person) return;
                const modalHtml = `
                <div class="modal active" id="person-details-modal">
                    <div class="modal-content" style="max-width: 700px;">
                        <div class="modal-header">
                            <h3>Détails: ${person.name}</h3>
                            <button class="close-modal" onclick="document.getElementById('person-details-modal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                                <div>
                                    <h4>Informations générales</h4>
                                    <p><strong>Type:</strong> ${person.type === 'income' ? 'Source d\'entrée' : 'Destination de sortie'}</p>
                                    <p><strong>Total transactions:</strong> ${person.transactionCount}</p>
                                    <p><strong>Montant total:</strong> ${this.formatCurrency(person.totalAmount)}</p>
                                    <p><strong>Première transaction:</strong> ${this.formatDateWithTime(person.firstTransaction)}</p>
                                    <p><strong>Dernière transaction:</strong> ${this.formatDateWithTime(person.lastTransaction)}</p>
                                </div>
                                <div>
                                    <h4>Statistiques</h4>
                                    <p><strong>Moyenne par transaction:</strong> ${this.formatCurrency((person.totalAmount || 0) / (person.transactionCount || 1))}</p>
                                    <p><strong>Fréquence:</strong> ${this.calculateFrequency ? this.calculateFrequency(person) : '-'}</p>
                                </div>
                            </div>
                            <h4>Historique des transactions</h4>
                            <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                                <table>
                                    <thead>
                                        <tr><th>Date</th><th>Type</th><th>Montant</th><th>Description</th></tr>
                                    </thead>
                                    <tbody id="person-transactions-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const tbody = document.getElementById('person-transactions-body');
                (person.transactions || []).forEach(tx => {
                    const row = document.createElement('tr');
                    const desc = this.getTransactionDescription ? this.getTransactionDescription(tx.id) : '-';
                    row.innerHTML = `<td>${this.formatDateWithTime(tx.date)}</td><td><span class="transaction-type ${tx.type === 'income' ? 'type-income' : 'type-expense'}">${tx.type === 'income' ? 'Entrée' : 'Sortie'}</span></td><td>${this.formatCurrency(tx.amount)}</td><td>${desc || '-'}</td>`;
                    tbody.appendChild(row);
                });
            },


            // Toast helper
            showToast(message, type = 'info', timeout = 3500) {
                const container = document.getElementById('toast-container');
                if (!container) return;
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<div style="flex:1">${message}</div>`;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(-6px)';
                }, timeout - 300);
                setTimeout(() => container.removeChild(toast), timeout);
            },

            // Confirm helper returns a Promise
            confirmModal(message, title = 'Confirmer') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('confirm-modal');
                    document.getElementById('confirm-title').textContent = title;
                    document.getElementById('confirm-message').textContent = message;
                    modal.classList.add('active');

                    const onOk = () => {
                        cleanup();
                        resolve(true);
                    };

                    const onCancel = () => {
                        cleanup();
                        resolve(false);
                    };

                    const cleanup = () => {
                        document.getElementById('confirm-ok-btn').removeEventListener('click', onOk);
                        document.getElementById('confirm-cancel-btn').removeEventListener('click', onCancel);
                        document.getElementById('close-confirm-modal').removeEventListener('click', onCancel);
                        modal.classList.remove('active');
                    };

                    document.getElementById('confirm-ok-btn').addEventListener('click', onOk);
                    document.getElementById('confirm-cancel-btn').addEventListener('click', onCancel);
                    document.getElementById('close-confirm-modal').addEventListener('click', onCancel);
                });
            },

            // Générer Excel via SheetJS
            generateExcel() {
                try {
                    const exportType = document.getElementById('export-type').value;
                    const period = document.getElementById('export-period').value;
                    const data = this.generateExportData(exportType, period, false);
                    if (!data || data.length === 0) {
                        this.showToast('Aucune donnée à exporter en Excel.', 'warning');
                        return;
                    }

                    const ws = XLSX.utils.aoa_to_sheet(data.map(r => Array.isArray(r) ? r : [r]));
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Export');
                    XLSX.writeFile(wb, `ben_wallet_${exportType}_${new Date().toISOString().split('T')[0]}.xlsx`);
                    this.closeExportModal();
                    this.showToast('Export Excel terminé.', 'success');
                } catch (err) {
                    console.error(err);
                    this.showToast('Erreur lors de la génération Excel.', 'danger');
                }
            },
            
            // Configuration des événements
            setupEventListeners() {
                // Navigation ===
    
              
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const tab = item.getAttribute('data-tab');
                        this.switchTab(tab);
                    });
                });
                
                // Toggle menu mobile
                document.getElementById('menu-toggle').addEventListener('click', () => {
                    document.getElementById('nav-menu').classList.toggle('active');
                });
                
              // Créer profil - DÉSACTIVÉ car on utilise onclick
//document.getElementById('create-profile-btn').addEventListener('click', () => {
//     this.createUserProfile();
// });
                
                // Tabs des transactions
                document.querySelectorAll('[data-transaction-tab]').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabType = tab.getAttribute('data-transaction-tab');
                        this.switchTransactionTab(tabType);
                    });
                });

                // Corriger la recherche dans les transactions pour appliquer le filtre actif
                document.getElementById('transaction-search')?.addEventListener('input', () => {
                    const activeTab = document.querySelector('[data-transaction-tab].active')?.getAttribute('data-transaction-tab') || 'all';
                    this.filterTransactions(activeTab);
                });
                
                // Bouton ajouter transaction
                document.getElementById('add-transaction-btn').addEventListener('click', () => {
                    this.showTransactionForm();
                });
                
                // Calculer l'allocation
                document.getElementById('calculate-allocation-btn').addEventListener('click', () => {
                    this.calculateAllocation();
                });
                
                // Enregistrer transaction
                document.getElementById('save-transaction-btn').addEventListener('click', () => {
                    this.saveTransaction();
                });
                
                // Annuler transaction
                document.getElementById('cancel-transaction-btn').addEventListener('click', () => {
                    this.cancelTransaction();
                });
                
                // Voir toutes les transactions
                document.getElementById('view-all-transactions').addEventListener('click', () => {
                    this.switchTab('transactions');
                });
                
                // Envoyer la dîme
                document.getElementById('send-tithe-btn').addEventListener('click', () => {
                    this.showProofModal('tithe');
                });
                
                // Envoyer l'offrande
                document.getElementById('send-offering-btn').addEventListener('click', () => {
                    this.showProofModal('offering');
                });
                
                // Envoyer les bâtisseurs
                document.getElementById('send-builders-btn').addEventListener('click', () => {
                    this.showProofModal('builders');
                });
                
                // Envoyer l'aumône
                document.getElementById('send-alms-btn').addEventListener('click', () => {
                    this.showProofModal('alms');
                });
                
                // Sauvegarder la preuve
                document.getElementById('save-proof-btn').addEventListener('click', () => {
                    this.saveProof();
                });
                
                // Fermer modals
                document.getElementById('close-proof-modal').addEventListener('click', () => {
                    this.closeProofModal();
                });
                
                document.getElementById('close-transaction-modal').addEventListener('click', () => {
                    this.closeTransactionModal();
                });
                
                document.getElementById('cancel-proof-btn').addEventListener('click', () => {
                    this.closeProofModal();
                });
                
                // Sauvegarder paramètres
                document.getElementById('save-settings-btn').addEventListener('click', () => {
                    this.saveSettings();
                });
                
                // Modifier profil
                document.getElementById('edit-profile-btn').addEventListener('click', () => {
                    this.editProfile();
                });
                
                // Réinitialiser données
                document.getElementById('reset-data-btn').addEventListener('click', async () => {
                    const ok = await this.confirmModal('Voulez-vous vraiment réinitialiser toutes les données? Cette action est irréversible.', 'Réinitialiser');
                    if (ok) this.resetData();
                });
                
                // Gestion du modal d'export
                document.getElementById('export-data-btn')?.addEventListener('click', () => {
                    this.showExportModal();
                });

                document.getElementById('close-export-modal')?.addEventListener('click', () => {
                    this.closeExportModal();
                });

                document.getElementById('cancel-export-btn')?.addEventListener('click', () => {
                    this.closeExportModal();
                });

                // Afficher/masquer les champs de période personnalisée
                document.getElementById('export-period')?.addEventListener('change', (e) => {
                    const customFields = document.getElementById('custom-period-fields');
                    if (customFields) customFields.style.display = e.target.value === 'custom' ? 'block' : 'none';
                });

                // Bouton de prévisualisation
                document.getElementById('preview-export-btn')?.addEventListener('click', () => {
                    this.updateExportPreview();
                });

                // Bouton de génération CSV
                document.getElementById('generate-export-btn')?.addEventListener('click', () => {
                    this.generateCSV();
                });

                // Excel export button
                document.getElementById('generate-excel-btn')?.addEventListener('click', () => {
                    this.generateExcel();
                });

                // Mettre à jour l'aperçu quand les options changent
                ['export-type', 'export-period', 'export-include-headers', 'export-format-numbers', 'export-include-empty'].forEach(id => {
                    document.getElementById(id)?.addEventListener('change', () => {
                        setTimeout(() => this.updateExportPreview(), 100);
                    });
                });

                // Mettre à jour l'aperçu quand les dates personnalisées changent
                document.getElementById('export-start-date')?.addEventListener('change', () => {
                    if (document.getElementById('export-period').value === 'custom') {
                        setTimeout(() => this.updateExportPreview(), 100);
                    }
                });

                document.getElementById('export-end-date')?.addEventListener('change', () => {
                    if (document.getElementById('export-period').value === 'custom') {
                        setTimeout(() => this.updateExportPreview(), 100);
                    }
                });
                
                // Télécharger rapport
                document.getElementById('download-report-btn').addEventListener('click', () => {
                    this.downloadReport();
                });
                
                // Définir objectifs
                document.getElementById('set-goals-btn').addEventListener('click', () => {
                    this.switchTab('settings');
                });

                // Bouton d'ajout de catégorie personnalisé
                document.getElementById('add-category-btn')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.addCustomCategory();
                });

                // Mise à jour du dropdown des catégories lors du changement de type de transaction
                document.getElementById('transaction-type')?.addEventListener('change', () => {
                    this.updateTransactionCategoryDropdown();
                });

                // Budgets: initialiser quand on clique sur l'onglet budgets
                document.addEventListener('click', (e) => {
                    if (e.target.closest('[data-tab="budgets"]') || e.target.closest('[data-tab="budgets"] *')) {
                        setTimeout(() => {
                            this.initBudgets();
                        }, 100);
                    }
                });

                // Quand on clique sur l'onglet récompenses, mettre à jour l'UI
                document.addEventListener('click', (e) => {
                    if (e.target.closest('[data-tab="rewards"]') || e.target.closest('[data-tab="rewards"] *')) {
                        setTimeout(() => {
                            this.updateGamificationUI();
                            this.renderBadgesCollection();
                        }, 100);
                    }
                });

                // Contacts tab type switches
                document.querySelectorAll('[data-contact-type]').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('[data-contact-type]').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        this.loadContacts();
                    });
                });

                // Search in contacts
                document.getElementById('contact-search')?.addEventListener('input', () => {
                    this.loadContacts();
                });

                // Filtre des badges
                document.getElementById('badge-filter')?.addEventListener('change', () => {
                    this.renderBadgesCollection();
                });

                // Sauvegarder les budgets via le bouton général des paramètres
                document.getElementById('save-settings-btn')?.addEventListener('click', () => {
                    this.saveBudgets();
                });

                // Boutons de calcul automatique
                document.getElementById('auto-calc-income')?.addEventListener('click', () => {
                    const avgIncome = this.calculateAverageIncome(3);
                    document.getElementById('monthly-income-budget').value = Math.round(avgIncome);
                    this.saveBudgets();
                });

                document.getElementById('auto-calc-expense')?.addEventListener('click', () => {
                    const avgExpense = this.calculateAverageExpense(3);
                    document.getElementById('monthly-expense-budget').value = Math.round(avgExpense);
                    this.saveBudgets();
                });

                // Ajouter un budget de catégorie
                document.getElementById('add-category-budget')?.addEventListener('click', () => {
                    this.showAddCategoryBudgetModal();
                });

                // Projection slider
                document.getElementById('projection-months')?.addEventListener('input', (e) => {
                    document.getElementById('projection-value').textContent = `${e.target.value} mois`;
                    this.updateProjection();
                });

                // Category budget modal buttons
                document.getElementById('close-category-budget-modal')?.addEventListener('click', () => {
                    document.getElementById('category-budget-modal').classList.remove('active');
                });

                document.getElementById('save-category-budget-btn')?.addEventListener('click', () => {
                    this.saveCategoryBudget();
                });

                document.getElementById('cancel-category-budget-btn')?.addEventListener('click', () => {
                    this.cancelCategoryBudget();
                });
                
                // Mettre à jour le pourcentage disponible
                this.updateAvailablePercentage();
                
                // Mettre à jour l'UI initiale
                this.updateUI();

                // Initialiser le convertisseur et la FAQ (si présents)
                this.setupCurrencyConverter && this.setupCurrencyConverter();
                this.setupFAQ && this.setupFAQ();
                
                // Vérifier l'installation PWA
                window.addEventListener('beforeinstallprompt', (e) => {
                    console.log('Ben Wallet peut être installé comme application');
                });
            },
            
            // Changer d'onglet
            switchTab(tab) {
                // Fermer le menu mobile si ouvert
                document.getElementById('nav-menu').classList.remove('active');
                
                // Mettre à jour la navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('data-tab') === tab) {
                        item.classList.add('active');
                    }
                });
                
                // Mettre à jour le contenu
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                document.getElementById(tab).classList.add('active');
                
                // Mettre à jour le titre
                const titles = {
                    dashboard: 'Tableau de bord',
                    transactions: 'Transactions',
                    accounts: 'Mes comptes',
                    allocations: 'Allocations',
                    reports: 'Rapports',
                    converter: 'Convertisseur',
                    contacts: 'Contacts',
                    faq: 'FAQ & Aide',
                    settings: 'Paramètres'
                };
                
                document.getElementById('page-title').textContent = titles[tab];
                
                // Charger les données spécifiques à l'onglet
                if (tab === 'transactions') {
                    this.loadTransactionsTable();
                } else if (tab === 'allocations') {
                    this.loadAllocationsHistory();
                } else if (tab === 'reports') {
                    this.loadReports();
                    this.updateCharts();
                } else if (tab === 'contacts') {
                    this.loadContacts();
                } else if (tab === 'converter') {
                    this.setupCurrencyConverter && this.setupCurrencyConverter();
                } else if (tab === 'faq') {
                    this.setupFAQ && this.setupFAQ();
                }
            },
            
            // Changer l'onglet des transactions
            switchTransactionTab(tabType) {
                document.querySelectorAll('[data-transaction-tab]').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.querySelector(`[data-transaction-tab="${tabType}"]`).classList.add('active');
                
                this.filterTransactions(tabType);
            },
            
            // Filtrer les transactions
            filterTransactions(filter) {
                console.log('Filtrage des transactions avec:', filter);
                const rows = document.querySelectorAll('#all-transactions-body tr');
                const searchTerm = document.getElementById('transaction-search')?.value.toLowerCase() || '';

                rows.forEach(row => {
                    const type = row.getAttribute('data-type');
                    const allocated = row.getAttribute('data-allocated') === 'true';
                    const rowText = row.textContent.toLowerCase();

                    // Filtre par type
                    let typeMatch = false;
                    switch(filter) {
                        case 'all': typeMatch = true; break;
                        case 'income': typeMatch = type === 'income'; break;
                        case 'expense': typeMatch = type === 'expense'; break;
                        case 'allocated': typeMatch = allocated === true; break;
                        default: typeMatch = true;
                    }

                    // Filtre par recherche
                    const searchMatch = !searchTerm || rowText.includes(searchTerm);

                    // Afficher si les deux filtres sont OK
                    row.style.display = (typeMatch && searchMatch) ? '' : 'none';
                });

                console.log(`Filtrage terminé (${filter})`);
            },
            
            // Afficher le formulaire de transaction
            showTransactionForm() {
                document.getElementById('transaction-amount').value = '';
                document.getElementById('transaction-source').value = '';
                document.getElementById('transaction-description').value = '';
                document.getElementById('allocation-preview').style.display = 'none';
                document.getElementById('save-transaction-btn').style.display = 'none';
                document.getElementById('cancel-transaction-btn').style.display = 'none';
                document.getElementById('calculate-allocation-btn').style.display = 'inline-flex';
                
                // Défilement vers le formulaire
                document.querySelector('.transaction-form').scrollIntoView({ behavior: 'smooth' });
            },
            
            // Calculer l'allocation
            calculateAllocation() {
                const amount = parseFloat(document.getElementById('transaction-amount').value);
                const source = document.getElementById('transaction-source').value;
                const type = document.getElementById('transaction-type').value;
                
                if (!amount || amount <= 0) {
                    alert('Veuillez entrer un montant valide');
                    return;
                }
                
                if (!source) {
                    alert('Veuillez spécifier la source ou le destinataire');
                    return;
                }
                
                // Si c'est une dépense, pas d'allocation
                if (type === 'expense') {
                    this.data.currentAllocation = null;
                    document.getElementById('allocation-preview').style.display = 'none';
                    document.getElementById('save-transaction-btn').style.display = 'inline-flex';
                    document.getElementById('cancel-transaction-btn').style.display = 'inline-flex';
                    document.getElementById('calculate-allocation-btn').style.display = 'none';
                    return;
                }
                
                // Calculer les allocations
                const tithe = amount * (this.data.settings.tithePercent / 100);
                const offering = amount * (this.data.settings.offeringPercent / 100);
                const builders = amount * (this.data.settings.buildersPercent / 100);
                const alms = amount * (this.data.settings.almsPercent / 100);
                const savings = amount * (this.data.settings.savingsPercent / 100);
                const investment = amount * (this.data.settings.investmentPercent / 100);
                const available = amount * (this.data.settings.availablePercent / 100);
                
                // Stocker l'allocation courante
                this.data.currentAllocation = {
                    amount,
                    source,
                    tithe,
                    offering,
                    builders,
                    alms,
                    savings,
                    investment,
                    available,
                    date: document.getElementById('transaction-date').value || new Date().toISOString().split('T')[0],
                    time: document.getElementById('transaction-time').value || new Date().toTimeString().substring(0, 5)
                };
                
                // Afficher l'aperçu
                const allocationGrid = document.querySelector('.allocation-grid');
                allocationGrid.innerHTML = '';
                
                const allocations = [
                    { name: 'Dîme', value: tithe, color: 'var(--danger-color)', percent: this.data.settings.tithePercent },
                    { name: 'Offrande', value: offering, color: 'var(--warning-color)', percent: this.data.settings.offeringPercent },
                    { name: 'Bâtisseurs', value: builders, color: 'var(--info-color)', percent: this.data.settings.buildersPercent },
                    { name: 'Aumône', value: alms, color: '#9b59b6', percent: this.data.settings.almsPercent },
                    { name: 'Épargne', value: savings, color: 'var(--success-color)', percent: this.data.settings.savingsPercent },
                    { name: 'Investissement', value: investment, color: 'var(--accent-dark)', percent: this.data.settings.investmentPercent },
                    { name: 'Disponible', value: available, color: 'var(--primary-color)', percent: this.data.settings.availablePercent }
                ];
                
                allocations.forEach(allocation => {
                    const allocationItem = document.createElement('div');
                    allocationItem.className = 'allocation-item';
                    allocationItem.style.borderLeftColor = allocation.color;
                    
                    allocationItem.innerHTML = `
                        <div class="allocation-title">${allocation.name} (${allocation.percent}%)</div>
                        <div class="allocation-value">${this.formatCurrency(allocation.value)}</div>
                    `;
                    
                    allocationGrid.appendChild(allocationItem);
                });
                
                document.getElementById('allocation-preview').style.display = 'block';
                document.getElementById('save-transaction-btn').style.display = 'inline-flex';
                document.getElementById('cancel-transaction-btn').style.display = 'inline-flex';
                document.getElementById('calculate-allocation-btn').style.display = 'none';
            },
            
            // Sauvegarder la transaction
            saveTransaction() {
                const amount = parseFloat(document.getElementById('transaction-amount').value);
                const source = document.getElementById('transaction-source').value;
                const description = document.getElementById('transaction-description').value;
                const type = document.getElementById('transaction-type').value;
                const categorySelect = document.getElementById('transaction-category');
                const categoryValue = categorySelect ? categorySelect.value : '';
                let category = 'other';
                let categoryId = null;

                if (categoryValue) {
                    if (categoryValue.startsWith('custom_')) {
                        categoryId = parseInt(categoryValue.split('_')[1]);
                        const customCat = this.data.settings.customCategories.find(c => c.id === categoryId);
                        category = customCat ? customCat.name : 'Autre';
                    } else {
                        category = categoryValue;
                    }
                }
                const date = document.getElementById('transaction-date').value || new Date().toISOString().split('T')[0];
                const time = document.getElementById('transaction-time').value || new Date().toTimeString().substring(0, 5);
                
                if (!amount || amount <= 0) {
                    alert('Veuillez entrer un montant valide');
                    return;
                }
                
                if (!source) {
                    alert('Veuillez spécifier la source ou le destinataire');
                    return;
                }
                
                // Créer la transaction
                const transaction = {
                    id: Date.now(),
                    type,
                    amount,
                    source,
                    description,
                    category,       // Nom de la catégorie
                    categoryId,     // ID si catégorie personnalisée
                    date,
                    time,
                    timestamp: new Date().toISOString()
                };
                
                // Si c'est une entrée et qu'il y a une allocation
                if (type === 'income' && this.data.currentAllocation) {
                    transaction.allocated = true;
                    transaction.allocation = this.data.currentAllocation;
                    
                    // Mettre à jour les comptes
                    this.data.accounts.tithe.balance += this.data.currentAllocation.tithe;
                    this.data.accounts.offering.balance += this.data.currentAllocation.offering;
                    this.data.accounts.builders.balance += this.data.currentAllocation.builders;
                    this.data.accounts.alms.balance += this.data.currentAllocation.alms;
                    this.data.accounts.savings.balance += this.data.currentAllocation.savings;
                    this.data.accounts.investment.balance += this.data.currentAllocation.investment;
                    this.data.accounts.available.balance += this.data.currentAllocation.available;
                    
                    // Mettre à jour la date de dernière transaction
                    this.data.accounts.savings.lastTransaction = `${date} ${time}`;
                    this.data.accounts.investment.lastTransaction = `${date} ${time}`;
                    this.data.accounts.available.lastTransaction = `${date} ${time}`;
                    
                    // Ajouter à l'historique des allocations
                    this.data.allocationsHistory.unshift({
                        ...this.data.currentAllocation,
                        transactionId: transaction.id
                    });
                    
                    // Limiter l'historique à 50 entrées
                    if (this.data.allocationsHistory.length > 50) {
                        this.data.allocationsHistory.pop();
                    }
                } else if (type === 'expense') {
                    // Pour une dépense, déduire du compte disponible
                    this.data.accounts.available.balance -= amount;
                    transaction.fromAccount = 'available';
                }
                
                // Ajouter à l'historique des transactions
                this.data.transactions.unshift(transaction);
                
                // Limiter à 100 transactions
                if (this.data.transactions.length > 100) {
                    this.data.transactions.pop();
                }
                
                // Sauvegarder
                this.saveData();

                // Suivi des personnes/sources
                if (type === 'income') {
                    this.trackPerson(source, amount, 'income', transaction.id);
                } else if (type === 'expense') {
                    this.trackPerson(source, amount, 'expense', transaction.id);
                }
                
                // Réinitialiser le formulaire
                this.cancelTransaction();
                
                // Mettre à jour l'UI
                this.updateUI();
                this.loadRecentTransactions();
                this.updateCharts();
                
                // Afficher un message de confirmation
                this.showToast('Transaction enregistrée avec succès!', 'success');
            },
            
            // Annuler la transaction
            cancelTransaction() {
                document.getElementById('transaction-amount').value = '';
                document.getElementById('transaction-source').value = '';
                document.getElementById('transaction-description').value = '';
                document.getElementById('allocation-preview').style.display = 'none';
                document.getElementById('save-transaction-btn').style.display = 'none';
                document.getElementById('cancel-transaction-btn').style.display = 'none';
                document.getElementById('calculate-allocation-btn').style.display = 'inline-flex';
                this.data.currentAllocation = null;
            },
            
            // Afficher le modal de preuve
            showProofModal(account) {
                this.data.currentProofAccount = account;
                document.getElementById('proof-modal').classList.add('active');
                document.getElementById('proof-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('proof-time').value = new Date().toTimeString().substring(0, 5);
            },
            
            // Sauvegarder la preuve
            saveProof() {
                const account = this.data.currentProofAccount;
                const proofType = document.getElementById('proof-type').value;
                const proofDetails = document.getElementById('proof-details').value;
                const proofDate = document.getElementById('proof-date').value;
                const proofTime = document.getElementById('proof-time').value;
                
                if (!proofDetails) {
                    this.showToast('Veuillez fournir des détails sur la preuve', 'warning');
                    return;
                }
                
                // Marquer comme envoyé
                this.data.accounts[account].sent = true;
                this.data.accounts[account].sentDate = proofDate;
                this.data.accounts[account].sentTime = proofTime;
                this.data.accounts[account].proof = {
                    type: proofType,
                    details: proofDetails,
                    date: proofDate,
                    time: proofTime
                };
                
                // Réinitialiser le solde (argent envoyé)
                this.data.accounts[account].balance = 0;
                
                // Sauvegarder
                this.saveData();
                
                // Fermer le modal
                this.closeProofModal();
                
                // Mettre à jour l'UI
                this.updateUI();
                this.updateCharts();
                
                this.showToast('Preuve enregistrée et compte réinitialisé!', 'success');
            },
            
            // Fermer le modal de preuve
            closeProofModal() {
                document.getElementById('proof-modal').classList.remove('active');
                document.getElementById('proof-type').value = 'screenshot';
                document.getElementById('proof-details').value = '';
                document.getElementById('proof-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('proof-time').value = new Date().toTimeString().substring(0, 5);
                this.data.currentProofAccount = null;
            },
            
            // Fermer le modal de transaction
            closeTransactionModal() {
                document.getElementById('transaction-details-modal').classList.remove('active');
            },
            
            // Sauvegarder les paramètres
            saveSettings() {
                // Récupérer les valeurs
                this.data.settings.tithePercent = parseInt(document.getElementById('tithe-percentage').value) || 10;
                this.data.settings.offeringPercent = parseInt(document.getElementById('offering-percentage').value) || 5;
                this.data.settings.buildersPercent = parseInt(document.getElementById('builders-percentage').value) || 10;
                this.data.settings.almsPercent = parseInt(document.getElementById('alms-percentage').value) || 5;
                this.data.settings.savingsPercent = parseInt(document.getElementById('savings-percentage').value) || 15;
                this.data.settings.investmentPercent = parseInt(document.getElementById('investment-percentage').value) || 15;
                this.data.settings.monthlySavingsGoal = parseInt(document.getElementById('monthly-savings-goal').value) || 50000;
                this.data.settings.monthlyInvestmentGoal = parseInt(document.getElementById('monthly-investment-goal').value) || 50000;
                
                // Mettre à jour le profil utilisateur
                const profile = JSON.parse(localStorage.getItem('benWalletUserProfile'));
                if (profile) {
                    profile.name = document.getElementById('user-name-settings').value;
                    profile.status = document.getElementById('user-status-settings').value;
                    profile.currency = document.getElementById('user-currency-settings').value;
                    profile.avatar = document.getElementById('user-avatar-settings').value;
                    localStorage.setItem('benWalletUserProfile', JSON.stringify(profile));
                }
                
                // Recalculer le pourcentage disponible
                this.updateAvailablePercentage();
                
                // Sauvegarder
                this.saveData();
                
                // Mettre à jour l'UI
                this.updateUI();
                this.updateCharts();
                
                this.showToast('Paramètres enregistrés avec succès!', 'success');
            },
            
            // Modifier le profil
            editProfile() {
                const profile = JSON.parse(localStorage.getItem('benWalletUserProfile'));
                if (profile) {
                    document.getElementById('user-name-settings').value = profile.name;
                    document.getElementById('user-status-settings').value = profile.status;
                    document.getElementById('user-currency-settings').value = profile.currency;
                    document.getElementById('user-avatar-settings').value = profile.avatar;
                }
            },
            
            // Mettre à jour le pourcentage disponible
            updateAvailablePercentage() {
                const totalAllocated = 
                    this.data.settings.tithePercent + 
                    this.data.settings.offeringPercent + 
                    this.data.settings.buildersPercent + 
                    this.data.settings.almsPercent + 
                    this.data.settings.savingsPercent + 
                    this.data.settings.investmentPercent;
                
                this.data.settings.availablePercent = 100 - totalAllocated;
                document.getElementById('available-percentage').value = this.data.settings.availablePercent;
            },

            // AJOUT: Gestion des catégories personnalisées
            addCustomCategory() {
                const nameInput = document.getElementById('new-category-name');
                const typeInput = document.getElementById('new-category-type');
                const colorInput = document.getElementById('new-category-color');
                
                if (!nameInput) return;
                const name = nameInput.value.trim();
                const type = typeInput.value;
                const color = colorInput.value;
                
                if (!name) {
                    this.showToast('Veuillez entrer un nom pour la catégorie', 'warning');
                    return;
                }

                const exists = this.data.settings.customCategories.some(
                    cat => cat.name.toLowerCase() === name.toLowerCase() && cat.type === type
                );

                if (exists) {
                    this.showToast('Cette catégorie existe déjà', 'warning');
                    return;
                }

                const newId = this.data.settings.customCategories.length > 0 ?
                    Math.max(...this.data.settings.customCategories.map(c => c.id)) + 1 : 1;

                this.data.settings.customCategories.push({ id: newId, name, type, color });
                this.saveData();
                this.renderCategoriesList();
                this.updateTransactionCategoryDropdown();

                nameInput.value = '';
                colorInput.value = '#2E8B57';

                this.showToast(`Catégorie "${name}" ajoutée avec succès !`, 'success');
            },

            async deleteCustomCategory(id) {
                // Vérifier si la catégorie est utilisée
                const isUsed = this.data.transactions.some(t => t.categoryId === id);
                if (isUsed) {
                    const ok = await this.confirmModal("Cette catégorie est utilisée dans des transactions. Voulez-vous quand même la supprimer ? Les transactions concernées seront marquées comme 'Autre'.", 'Supprimer catégorie');
                    if (!ok) return;

                    this.data.transactions.forEach(t => {
                        if (t.categoryId === id) {
                            t.categoryId = null;
                            t.category = 'other';
                        }
                    });
                }

                this.data.settings.customCategories = this.data.settings.customCategories.filter(c => c.id !== id);
                this.saveData();
                this.renderCategoriesList();
                this.updateTransactionCategoryDropdown();

                this.showToast('Catégorie supprimée avec succès !', 'success');
            },

            renderCategoriesList() {
                const container = document.getElementById('categories-list');
                if (!container) return;

                container.innerHTML = '';

                if (!this.data.settings.customCategories || this.data.settings.customCategories.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 25px; color: #6c757d; background: #f8f9fa; border-radius: 8px;">
                            <i class="fas fa-tags" style="font-size: 32px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                            <div style="font-weight: 600; margin-bottom: 8px;">Aucune catégorie personnalisée</div>
                            <div style="font-size: 14px;">Utilisez le formulaire ci-dessous pour créer votre première catégorie</div>
                        </div>
                    `;
                    return;
                }

                const sortedCategories = [...this.data.settings.customCategories].sort((a, b) => {
                    if (a.type !== b.type) return a.type === 'income' ? -1 : 1;
                    return a.name.localeCompare(b.name);
                });

                sortedCategories.forEach(category => {
                    const categoryEl = document.createElement('div');
                    categoryEl.className = 'category-item';
                    categoryEl.style.cssText = `
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 15px;
                        background: white;
                        border-left: 5px solid ${category.color};
                        border-radius: 10px;
                        margin-bottom: 12px;
                        box-shadow: 0 3px 10px rgba(0,0,0,0.05);
                        transition: transform 0.2s, box-shadow 0.2s;
                    `;

                    categoryEl.onmouseover = () => {
                        categoryEl.style.transform = 'translateY(-2px)';
                        categoryEl.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
                    };
                    categoryEl.onmouseout = () => {
                        categoryEl.style.transform = '';
                        categoryEl.style.boxShadow = '0 3px 10px rgba(0,0,0,0.05)';
                    };

                    categoryEl.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: ${category.color}; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                            <div>
                                <div style="font-weight: 700; font-size: 16px; color: #343a40;">${category.name}</div>
                                <div style="font-size: 14px; color: #6c757d;">
                                    <span class="badge" style="background: ${category.type === 'income' ? 'rgba(46, 139, 87, 0.1)' : 'rgba(220, 20, 60, 0.1)'}; color: ${category.type === 'income' ? '#2E8B57' : '#DC143C'}; padding: 3px 10px; border-radius: 20px; font-size: 12px;">
                                        ${category.type === 'income' ? 'Revenu' : 'Dépense'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-danger delete-category-btn" data-id="${category.id}" style="padding: 6px 12px; font-size: 14px;">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </div>
                    `;

                    container.appendChild(categoryEl);
                });

                container.querySelectorAll('.delete-category-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.target.closest('.delete-category-btn').getAttribute('data-id'));
                        this.deleteCustomCategory(id);
                    });
                });
            },
            
            // Réinitialiser les données
            resetData() {
                this.data = {
                    settings: {
                        tithePercent: 10,
                        offeringPercent: 5,
                        buildersPercent: 10,
                        almsPercent: 5,
                        savingsPercent: 15,
                        investmentPercent: 15,
                        availablePercent: 40,
                        monthlySavingsGoal: 50000,
                        monthlyInvestmentGoal: 50000,
                        customCategories: [
                            { id: 1, name: "Salaire", type: "income", color: "#2E8B57" },
                            { id: 2, name: "Cadeau", type: "income", color: "#4169E1" },
                            { id: 3, name: "Affaires", type: "income", color: "#9b59b6" },
                            { id: 4, name: "Autre revenu", type: "income", color: "#FF8C00" },
                            { id: 5, name: "Alimentation", type: "expense", color: "#DC143C" },
                            { id: 6, name: "Transport", type: "expense", color: "#1E90FF" },
                            { id: 7, name: "Loisirs", type: "expense", color: "#FF69B4" },
                            { id: 8, name: "Santé", type: "expense", color: "#32CD32" }
                        ]
                    },
                    transactions: [],
                    accounts: {
                        tithe: { balance: 0, sent: false, sentDate: null, sentTime: null, proof: null },
                        offering: { balance: 0, sent: false, sentDate: null, sentTime: null, proof: null },
                        builders: { balance: 0, sent: false, sentDate: null, sentTime: null, proof: null },
                        alms: { balance: 0, sent: false, sentDate: null, sentTime: null, proof: null },
                        savings: { balance: 0, lastTransaction: null, startDate: new Date().toISOString().split('T')[0] },
                        investment: { balance: 0, lastTransaction: null, startDate: new Date().toISOString().split('T')[0] },
                        available: { balance: 0, lastTransaction: null }
                    },
                    allocationsHistory: [],
                    currentAllocation: null,
                    currentProofAccount: null
                };
                
                this.saveData();
                this.updateUI();
                this.loadRecentTransactions();
                this.updateCharts();
                
                this.showToast('Toutes les données ont été réinitialisées!', 'success');
            },
            
            // Exporter les données
            exportData() {
                const profile = JSON.parse(localStorage.getItem('benWalletUserProfile'));
                const exportData = {
                    profile: profile,
                    appData: this.data,
                    exportDate: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `ben_wallet_backup_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            },

            // ========== MÉTHODES D'EXPORT CSV ==========

            // Afficher le modal d'export
            showExportModal() {
                const modal = document.getElementById('export-modal');
                if (!modal) return;
                modal.classList.add('active');
                
                // Définir les dates par défaut
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                
                document.getElementById('export-start-date').value = firstDay.toISOString().split('T')[0];
                document.getElementById('export-end-date').value = now.toISOString().split('T')[0];
                
                // Initialiser l'aperçu
                this.updateExportPreview();
            },

            // Fermer le modal d'export
            closeExportModal() {
                const modal = document.getElementById('export-modal');
                if (!modal) return;
                modal.classList.remove('active');
            },

            // Mettre à jour l'aperçu de l'export
            updateExportPreview() {
                const previewContent = document.getElementById('preview-content');
                if (!previewContent) return;
                const exportTypeEl = document.getElementById('export-type');
                const exportPeriodEl = document.getElementById('export-period');
                const exportType = exportTypeEl ? exportTypeEl.value : 'transactions';
                const period = exportPeriodEl ? exportPeriodEl.value : 'current-month';
                
                previewContent.innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;"><i class="fas fa-spinner fa-spin"></i> Génération de l\'aperçu...</div>';
                
                setTimeout(() => {
                    const data = this.generateExportData(exportType, period, true);
                    if (data && data.length > 0) {
                        let previewHTML = '';
                        const maxLines = Math.min(data.length, 10);
                        for (let i = 0; i < maxLines; i++) {
                            const row = data[i];
                            previewHTML += `<div style="padding: 3px 0; border-bottom: ${i === 0 && document.getElementById('export-include-headers').checked ? '2px solid #495057' : '1px solid #dee2e6'};">`;
                            if (Array.isArray(row)) {
                                previewHTML += row.map(cell => `<span style="display: inline-block; padding: 0 8px; min-width: 100px;">${cell || ''}</span>`).join('');
                            } else {
                                previewHTML += `<span>${row}</span>`;
                            }
                            previewHTML += '</div>';
                        }

                        if (data.length > 10) {
                            previewHTML += `<div style="padding: 8px; text-align: center; color: #6c757d; font-style: italic;">... et ${data.length - 10} lignes supplémentaires</div>`;
                        }

                        previewContent.innerHTML = previewHTML;
                    } else {
                        previewContent.innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">Aucune donnée à exporter pour ces critères.</div>';
                    }
                }, 500);
            },

            // Générer les données d'export
            generateExportData(exportType, period, preview = false) {
                const includeHeaders = document.getElementById('export-include-headers')?.checked;
                const formatNumbers = document.getElementById('export-format-numbers')?.checked;
                const includeEmpty = document.getElementById('export-include-empty')?.checked;
                
                let startDate, endDate;
                const now = new Date();
                switch(period) {
                    case 'current-month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                        break;
                    case 'last-month':
                        startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                        break;
                    case 'current-year':
                        startDate = new Date(now.getFullYear(), 0, 1);
                        endDate = new Date(now.getFullYear(), 11, 31);
                        break;
                    case 'custom':
                        const startStr = document.getElementById('export-start-date').value;
                        const endStr = document.getElementById('export-end-date').value;
                        if (!startStr || !endStr) {
                            alert('Veuillez spécifier les dates de début et fin');
                            return [];
                        }
                        startDate = new Date(startStr);
                        endDate = new Date(endStr);
                        break;
                    default:
                        startDate = new Date(2000, 0, 1);
                        endDate = new Date(2100, 0, 1);
                }

                const formatDateForCSV = (dateStr) => {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
                };

                const formatNumberForCSV = (num) => {
                    if (num === null || num === undefined) return includeEmpty ? '' : '0';
                    if (!formatNumbers) return num.toString();
                    return new Intl.NumberFormat('fr-FR', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(num);
                };

                const data = [];

                switch(exportType) {
                    case 'transactions':
                        if (includeHeaders) {
                            data.push(['ID', 'Date', 'Heure', 'Type', 'Montant', 'Source/Destinataire', 'Catégorie', 'Description', 'Allouée', 'Compte source']);
                        }

                        this.data.transactions
                            .filter(t => {
                                const tDate = new Date(t.date);
                                return tDate >= startDate && tDate <= endDate;
                            })
                            .forEach(t => {
                                data.push([
                                    t.id,
                                    formatDateForCSV(t.date),
                                    t.time || '',
                                    t.type === 'income' ? 'Entrée' : 'Dépense',
                                    formatNumberForCSV(t.amount),
                                    t.source,
                                    t.category || '',
                                    t.description || '',
                                    t.allocated ? 'Oui' : 'Non',
                                    t.fromAccount || (t.allocated ? 'Multiple' : '')
                                ]);
                            });
                        break;

                    case 'allocations':
                        if (includeHeaders) {
                            data.push(['ID Transaction', 'Date', 'Montant source', 'Source', 'Dîme (10%)', 'Offrande (5%)', 'Bâtisseurs (10%)', 'Aumône (5%)', 'Épargne (15%)', 'Investissement (15%)', 'Disponible (40%)']);
                        }

                        this.data.allocationsHistory
                            .filter(a => {
                                const aDate = new Date(a.date);
                                return aDate >= startDate && aDate <= endDate;
                            })
                            .forEach(a => {
                                data.push([
                                    a.transactionId || '',
                                    formatDateForCSV(a.date),
                                    formatNumberForCSV(a.amount),
                                    a.source,
                                    formatNumberForCSV(a.tithe),
                                    formatNumberForCSV(a.offering),
                                    formatNumberForCSV(a.builders),
                                    formatNumberForCSV(a.alms),
                                    formatNumberForCSV(a.savings),
                                    formatNumberForCSV(a.investment),
                                    formatNumberForCSV(a.available)
                                ]);
                            });
                        break;

                    case 'categories':
                        if (includeHeaders) {
                            data.push(['Catégorie', 'Type', 'Nombre transactions', 'Montant total', 'Moyenne par transaction', 'Pourcentage du total']);
                        }

                        const categoryStats = {};
                        this.data.transactions
                            .filter(t => {
                                const tDate = new Date(t.date);
                                return tDate >= startDate && tDate <= endDate;
                            })
                            .forEach(t => {
                                const catName = t.category || 'Autre';
                                if (!categoryStats[catName]) {
                                    categoryStats[catName] = { type: t.type, count: 0, total: 0 };
                                }
                                categoryStats[catName].count++;
                                categoryStats[catName].total += t.amount;
                            });

                        const grandTotal = Object.values(categoryStats).reduce((sum, stat) => sum + stat.total, 0);
                        Object.entries(categoryStats).forEach(([category, stats]) => {
                            const percentage = grandTotal > 0 ? (stats.total / grandTotal * 100).toFixed(1) : 0;
                            const average = stats.count > 0 ? stats.total / stats.count : 0;
                            data.push([category, stats.type === 'income' ? 'Revenu' : 'Dépense', stats.count, formatNumberForCSV(stats.total), formatNumberForCSV(average), `${percentage}%`]);
                        });
                        break;

                    case 'full-report':
                        if (includeHeaders) {
                            data.push(['RAPPORT COMPLET BEN WALLET']);
                            data.push(['Généré le', new Date().toLocaleDateString('fr-FR')]);
                            data.push(['Période', `${formatDateForCSV(startDate.toISOString())} - ${formatDateForCSV(endDate.toISOString())}`]);
                            data.push([]);
                            data.push(['SYNTHÈSE FINANCIÈRE']);
                            data.push([]);
                        }

                        let totalIncome = 0, totalExpense = 0, totalAllocated = 0;
                        const filteredTransactions = this.data.transactions.filter(t => {
                            const tDate = new Date(t.date);
                            return tDate >= startDate && tDate <= endDate;
                        });

                        filteredTransactions.forEach(t => {
                            if (t.type === 'income') {
                                totalIncome += t.amount;
                                if (t.allocated) totalAllocated += t.amount;
                            } else {
                                totalExpense += t.amount;
                            }
                        });

                        data.push(['Revenus totaux:', formatNumberForCSV(totalIncome)]);
                        data.push(['Dépenses totales:', formatNumberForCSV(totalExpense)]);
                        data.push(['Revenus alloués:', formatNumberForCSV(totalAllocated)]);
                        data.push(['Balance nette:', formatNumberForCSV(totalIncome - totalExpense)]);
                        data.push([]);
                        data.push(['Pourcentage d\'allocation:', totalIncome > 0 ? `${((totalAllocated / totalIncome) * 100).toFixed(1)}%` : '0%']);
                        data.push([]);

                        if (filteredTransactions.length > 0) {
                            data.push(['DÉTAIL DES TRANSACTIONS']);
                            data.push([]);
                            data.push(['Date', 'Type', 'Montant', 'Source', 'Catégorie', 'Description']);
                            filteredTransactions.forEach(t => {
                                data.push([formatDateForCSV(t.date), t.type === 'income' ? 'Entrée' : 'Dépense', formatNumberForCSV(t.amount), t.source, t.category || '', t.description || '']);
                            });
                        }
                        break;
                }

                return preview ? data.slice(0, 11) : data;
            },

            // Générer et télécharger le CSV
            generateCSV() {
                const exportType = document.getElementById('export-type').value;
                const period = document.getElementById('export-period').value;
                const data = this.generateExportData(exportType, period);
                if (data.length === 0) {
                    alert('Aucune donnée à exporter pour ces critères.');
                    return;
                }

                let csvContent = '';
                data.forEach(row => {
                    if (Array.isArray(row)) {
                        csvContent += row.map(cell => {
                            const cellStr = cell !== null && cell !== undefined ? cell.toString() : '';
                            if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                                return `"${cellStr.replace(/"/g, '""')}"`;
                            }
                            return cellStr;
                        }).join(',') + '\n';
                    } else {
                        csvContent += row + '\n';
                    }
                });

                const now = new Date();
                const fileName = `ben_wallet_${exportType}_${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}.csv`;

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (navigator.msSaveBlob) {
                    navigator.msSaveBlob(blob, fileName);
                } else {
                    link.href = URL.createObjectURL(blob);
                    link.setAttribute('download', fileName);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                this.closeExportModal();
                alert(`Export CSV terminé ! ${data.length} lignes exportées.`);
            },

            // ========== MÉTHODES BUDGETS ==========

            // Initialiser les budgets
            initBudgets() {
                // Charger les valeurs depuis les paramètres
                const budgetInputs = ['monthly-income-budget', 'monthly-expense-budget'];
                budgetInputs.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        const key = id.replace('monthly-', '').replace('-budget', '');
                        const value = this.data.settings.budgets.monthly[key] || 0;
                        element.value = value;
                    }
                });
                
                // Mettre à jour l'interface
                this.updateBudgetDisplay();
                this.renderCategoryBudgets();
                this.updateProjection();
            },

            // Mettre à jour l'affichage des budgets
            updateBudgetDisplay() {
                const now = new Date();
                const month = now.getMonth() + 1;
                const year = now.getFullYear();
                
                // Calculer les totaux actuels
                let currentIncome = 0;
                let currentExpense = 0;
                
                this.data.transactions.forEach(transaction => {
                    const transactionDate = new Date(transaction.date);
                    if (transactionDate.getMonth() + 1 === month && transactionDate.getFullYear() === year) {
                        if (transaction.type === 'income') {
                            currentIncome += transaction.amount;
                        } else {
                            currentExpense += transaction.amount;
                        }
                    }
                });
                
                // Mettre à jour les affichages
                document.getElementById('current-income').textContent = this.formatCurrency(currentIncome);
                document.getElementById('current-expense').textContent = this.formatCurrency(currentExpense);
                document.getElementById('income-target').textContent = this.formatCurrency(this.data.settings.budgets.monthly.income);
                document.getElementById('expense-target').textContent = this.formatCurrency(this.data.settings.budgets.monthly.expense);
                
                // Calculer les pourcentages
                const incomePercent = this.data.settings.budgets.monthly.income > 0 
                    ? Math.min(100, (currentIncome / this.data.settings.budgets.monthly.income) * 100)
                    : 0;
                
                const expensePercent = this.data.settings.budgets.monthly.expense > 0 
                    ? Math.min(100, (currentExpense / this.data.settings.budgets.monthly.expense) * 100)
                    : 0;
                
                // Mettre à jour les barres de progression
                document.getElementById('income-progress').style.width = `${incomePercent}%`;
                document.getElementById('expense-progress').style.width = `${expensePercent}%`;
                
                // Générer des recommandations
                this.generateBudgetRecommendations(currentIncome, currentExpense);
                
                // Mettre à jour l'historique
                this.updateBudgetHistory();
            },

            // Générer des recommandations budgétaires
            generateBudgetRecommendations(currentIncome, currentExpense) {
                const recommendations = document.getElementById('budget-recommendations');
                if (!recommendations) return;
                
                recommendations.innerHTML = '';
                
                const incomeBudget = this.data.settings.budgets.monthly.income;
                const expenseBudget = this.data.settings.budgets.monthly.expense;
                
                const tips = [];
                
                // Vérifier le budget dépenses
                if (expenseBudget > 0) {
                    const expenseRatio = (currentExpense / expenseBudget) * 100;
                    
                    if (expenseRatio > 90) {
                        tips.push({
                            icon: 'fas fa-exclamation-triangle',
                            color: 'var(--danger-color)',
                            text: 'Dépenses proches du budget maximal!'
                        });
                    } else if (expenseRatio > 70) {
                        tips.push({
                            icon: 'fas fa-exclamation-circle',
                            color: 'var(--warning-color)',
                            text: 'Dépenses à surveiller'
                        });
                    }
                }
                
                // Vérifier les revenus
                if (incomeBudget > 0) {
                    const incomeRatio = (currentIncome / incomeBudget) * 100;
                    
                    if (incomeRatio < 50) {
                        tips.push({
                            icon: 'fas fa-money-bill-wave',
                            color: 'var(--info-color)',
                            text: 'Revenus inférieurs aux prévisions'
                        });
                    }
                }
                
                // Vérifier l'épargne
                const savings = this.data.accounts.savings.balance;
                const savingsGoal = this.data.settings.monthlySavingsGoal;
                
                if (savingsGoal > 0 && savings < savingsGoal * 0.5) {
                    tips.push({
                        icon: 'fas fa-piggy-bank',
                        color: 'var(--accent-color)',
                        text: 'Épargne en retard sur l\'objectif'
                    });
                }
                
                // Afficher les recommandations
                if (tips.length === 0) {
                    tips.push({
                        icon: 'fas fa-check-circle',
                        color: 'var(--success-color)',
                        text: 'Budget bien respecté ce mois!'
                    });
                }
                
                tips.forEach(tip => {
                    const tipEl = document.createElement('div');
                    tipEl.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 10px;
                        background: ${tip.color}15;
                        border-left: 3px solid ${tip.color};
                        border-radius: 6px;
                        margin-bottom: 8px;
                        font-size: 14px;
                    `;
                    
                    tipEl.innerHTML = `
                        <i class="${tip.icon}" style="color: ${tip.color};"></i>
                        <span>${tip.text}</span>
                    `;
                    
                    recommendations.appendChild(tipEl);
                });
            },

            // Mettre à jour les projections
            updateProjection() {
                const months = parseInt(document.getElementById('projection-months').value);
                document.getElementById('projection-value').textContent = `${months} mois`;
                
                // Calculer la projection d'épargne
                const currentSavings = this.data.accounts.savings.balance;
                const monthlySavings = this.data.settings.monthlySavingsGoal;
                
                // Générer un graphique simple
                const projectionContainer = document.getElementById('savings-projection');
                
                let projectionHTML = '<div style="text-align: center; width: 100%;">';
                
                for (let i = 0; i <= months; i += 3) {
                    const projectedSavings = currentSavings + (monthlySavings * i);
                    const height = Math.min(100, (projectedSavings / (monthlySavings * 12)) * 50);
                    
                    projectionHTML += `
                        <div style="display: inline-block; margin: 0 5px; text-align: center;">
                            <div style="width: 20px; height: ${height}px; background: var(--success-color); margin: 0 auto 5px; border-radius: 3px;"></div>
                            <div style="font-size: 11px; color: #6c757d;">M+${i}</div>
                        </div>
                    `;
                }
                
                projectionHTML += '</div>';
                projectionContainer.innerHTML = projectionHTML;
                
                // Mettre à jour le conseil
                this.updateBudgetTip();
            },

            // Mettre à jour le conseil budgétaire
            updateBudgetTip() {
                const tipContainer = document.getElementById('budget-tip');
                if (!tipContainer) return;
                
                const tips = [
                    "Essayez de réduire vos dépenses alimentaires de 10% ce mois-ci.",
                    "Considérez investir 15% de vos revenus supplémentaires.",
                    "Revoyez vos abonnements récurrents pour optimiser vos dépenses.",
                    "Établissez un fonds d'urgence équivalent à 3 mois de dépenses.",
                    "Utilisez la règle 50/30/20: 50% besoins, 30% envies, 20% épargne.",
                    "Planifiez vos achats importants à l'avance pour mieux budgéter.",
                    "Revoyez vos assurances pour optimiser vos dépenses mensuelles.",
                    "Considérez automatiser votre épargne pour garantir votre objectif."
                ];
                
                // Afficher le premier conseil par défaut (évite contenu aléatoire en démonstration)
                tipContainer.textContent = tips[0];
            },

            // Gérer les budgets par catégorie
            renderCategoryBudgets() {
                const container = document.getElementById('category-budgets-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                const categoryBudgets = this.data.settings.budgets.monthly.categories;
                
                // Récupérer toutes les catégories de dépenses
                const expenseCategories = (this.data.settings.customCategories || []).filter(c => c.type === 'expense');
                
                expenseCategories.forEach(category => {
                    const budget = categoryBudgets[category.name] || 0;
                    const spent = this.calculateCategorySpending(category.name);
                    const percentage = budget > 0 ? (spent / budget * 100) : 0;
                    
                    const categoryEl = document.createElement('div');
                    categoryEl.className = 'category-budget-item';
                    categoryEl.style.cssText = `
                        padding: 12px;
                        background: white;
                        border-radius: 8px;
                        margin-bottom: 10px;
                        border-left: 4px solid ${category.color};
                        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                    `;
                    
                    categoryEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: #495057;">${category.name}</div>
                            <button class="btn btn-sm btn-danger delete-category-budget" data-category="${category.name}" style="padding: 2px 8px; font-size: 12px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 8px;">
                            <span>Budget: <strong>${this.formatCurrency(budget)}</strong></span>
                            <span>Dépensé: <strong>${this.formatCurrency(spent)}</strong></span>
                        </div>
                        <div class="card-progress" style="height: 6px;">
                            <div class="progress-bar" style="width: ${Math.min(100, percentage)}%; background: ${category.color};"></div>
                        </div>
                        <div style="text-align: right; font-size: 12px; color: #6c757d; margin-top: 5px;">
                            ${percentage.toFixed(1)}% du budget
                        </div>
                    `;
                    
                    container.appendChild(categoryEl);
                });
                
                // Ajouter les écouteurs pour supprimer les budgets
                container.querySelectorAll('.delete-category-budget').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const category = e.target.closest('.delete-category-budget').getAttribute('data-category');
                        this.deleteCategoryBudget(category);
                    });
                });
            },

            // Calculer les dépenses par catégorie
            calculateCategorySpending(categoryName) {
                const now = new Date();
                const month = now.getMonth() + 1;
                const year = now.getFullYear();
                
                return this.data.transactions
                    .filter(t => {
                        const tDate = new Date(t.date);
                        return t.type === 'expense' && 
                               t.category === categoryName &&
                               tDate.getMonth() + 1 === month && 
                               tDate.getFullYear() === year;
                    })
                    .reduce((sum, t) => sum + t.amount, 0);
            },

            // Supprimer un budget de catégorie
            deleteCategoryBudget(categoryName) {
                if (confirm(`Supprimer le budget pour "${categoryName}" ?`)) {
                    delete this.data.settings.budgets.monthly.categories[categoryName];
                    this.saveData();
                    this.renderCategoryBudgets();
                }
            },

            // Mettre à jour l'historique des budgets
            updateBudgetHistory() {
                const container = document.getElementById('budget-history-body');
                if (!container) return;
                
                container.innerHTML = '';
                // Si l'app stocke un historique réel (ex: this.data.budgetsHistory), l'afficher.
                // Sinon, afficher un message d'information invitant à définir des budgets.
                const history = this.data.budgetsHistory || [];
                if (history.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="7" style="text-align:center; color:#6c757d; padding:20px;">Aucun historique de budget disponible. Définissez vos budgets pour voir l'historique ici.</td>`;
                    container.appendChild(row);
                    return;
                }

                // Si un historique est présent, afficher chronologiquement
                history.forEach(entry => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${entry.month || ''}</td>
                        <td>${this.formatCurrency(entry.plannedIncome || 0)}</td>
                        <td>${this.formatCurrency(entry.actualIncome || 0)}</td>
                        <td>${this.formatCurrency(entry.plannedExpense || 0)}</td>
                        <td>${this.formatCurrency(entry.actualExpense || 0)}</td>
                        <td style="color: ${((entry.actualIncome || 0) - (entry.plannedIncome || 0)) >= 0 ? 'var(--success-color)' : 'var(--danger-color)'}; font-weight: 600;">
                            ${((entry.actualIncome || 0) - (entry.plannedIncome || 0)) >= 0 ? '+' : ''}${this.formatCurrency((entry.actualIncome || 0) - (entry.plannedIncome || 0))}
                        </td>
                        <td>
                            <span class="badge" style="background: ${((entry.actualIncome || 0) - (entry.plannedIncome || 0)) >= 0 ? 'rgba(46, 139, 87, 0.1)' : 'rgba(220, 20, 60, 0.1)'}; color: ${((entry.actualIncome || 0) - (entry.plannedIncome || 0)) >= 0 ? '#2E8B57' : '#DC143C'}; padding: 3px 10px; border-radius: 20px;">
                                ${((entry.actualIncome || 0) - (entry.plannedIncome || 0)) >= 0 ? 'Sur-performance' : 'Sous-performance'}
                            </span>
                        </td>
                    `;
                    container.appendChild(row);
                });
            },

            // Sauvegarder les budgets
            saveBudgets() {
                // Sauvegarder les budgets mensuels
                this.data.settings.budgets.monthly.income = parseInt(document.getElementById('monthly-income-budget').value) || 0;
                this.data.settings.budgets.monthly.expense = parseInt(document.getElementById('monthly-expense-budget').value) || 0;
                
                this.saveData();
                this.updateBudgetDisplay();
                
                this.showToast('Budgets sauvegardés avec succès!', 'success');
            },

            // Méthode pour calculer la moyenne des revenus
            calculateAverageIncome(months = 3) {
                const now = new Date();
                let total = 0;
                let count = 0;
                
                for (let i = 0; i < months; i++) {
                    const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const monthIncome = this.data.transactions
                        .filter(t => {
                            const tDate = new Date(t.date);
                            return t.type === 'income' && 
                                   tDate.getMonth() === targetDate.getMonth() && 
                                   tDate.getFullYear() === targetDate.getFullYear();
                        })
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    if (monthIncome > 0) {
                        total += monthIncome;
                        count++;
                    }
                }
                
                return count > 0 ? total / count : 0;
            },

            // Méthode pour calculer la moyenne des dépenses
            calculateAverageExpense(months = 3) {
                const now = new Date();
                let total = 0;
                let count = 0;
                
                for (let i = 0; i < months; i++) {
                    const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const monthExpense = this.data.transactions
                        .filter(t => {
                            const tDate = new Date(t.date);
                            return t.type === 'expense' && 
                                   tDate.getMonth() === targetDate.getMonth() && 
                                   tDate.getFullYear() === targetDate.getFullYear();
                        })
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    if (monthExpense > 0) {
                        total += monthExpense;
                        count++;
                    }
                }
                
                return count > 0 ? total / count : 0;
            },

            // Afficher le modal d'ajout de budget de catégorie
            showAddCategoryBudgetModal() {
                const modal = document.getElementById('category-budget-modal');
                if (!modal) return;

                // Remplir la liste des catégories
                const select = document.getElementById('budget-category-select');
                select.innerHTML = '';
                const expenseCategories = (this.data.settings.customCategories || []).filter(c => c.type === 'expense');
                expenseCategories.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.name;
                    opt.textContent = c.name;
                    select.appendChild(opt);
                });

                modal.classList.add('active');
            },

            // Sauvegarder un budget de catégorie depuis le modal
            saveCategoryBudget() {
                const category = document.getElementById('budget-category-select').value;
                const amount = parseInt(document.getElementById('category-budget-amount').value) || 0;
                if (!category) {
                    alert('Veuillez choisir une catégorie');
                    return;
                }

                this.data.settings.budgets.monthly.categories[category] = amount;
                this.saveData();
                this.renderCategoryBudgets();
                document.getElementById('category-budget-modal').classList.remove('active');
            },

            // Annuler le modal de budget de catégorie
            cancelCategoryBudget() {
                document.getElementById('category-budget-amount').value = '';
                document.getElementById('category-budget-modal').classList.remove('active');
            },
            
            // Télécharger le rapport
            downloadReport() {
                const month = parseInt(document.getElementById('month-select').value);
                const year = parseInt(document.getElementById('year-select').value);
                
                let monthlyIncome = 0;
                let monthlyExpense = 0;
                let monthlySavings = 0;
                let monthlyInvestment = 0;
                
                this.data.transactions.forEach(transaction => {
                    const transactionDate = new Date(transaction.date);
                    if (transactionDate.getMonth() + 1 === month && transactionDate.getFullYear() === year) {
                        if (transaction.type === 'income') {
                            monthlyIncome += transaction.amount;
                            
                            if (transaction.allocated && transaction.allocation) {
                                monthlySavings += transaction.allocation.savings;
                                monthlyInvestment += transaction.allocation.investment;
                            }
                        } else {
                            monthlyExpense += transaction.amount;
                        }
                    }
                });
                
                const report = `
RAPPORT MENSUEL BEN WALLET
==========================
Mois: ${month}/${year}
Date de génération: ${new Date().toLocaleDateString('fr-FR')}

SOLDE TOTAL: ${this.formatCurrency(
    this.data.accounts.tithe.balance +
    this.data.accounts.offering.balance +
    this.data.accounts.builders.balance +
    this.data.accounts.alms.balance +
    this.data.accounts.savings.balance +
    this.data.accounts.investment.balance +
    this.data.accounts.available.balance
)}

COMPTES:
--------
Dîme: ${this.formatCurrency(this.data.accounts.tithe.balance)} ${this.data.accounts.tithe.sent ? '(Envoyée)' : '(À envoyer)'}
Offrande: ${this.formatCurrency(this.data.accounts.offering.balance)} ${this.data.accounts.offering.sent ? '(Envoyée)' : '(À envoyer)'}
Bâtisseurs: ${this.formatCurrency(this.data.accounts.builders.balance)} ${this.data.accounts.builders.sent ? '(Envoyée)' : '(À envoyer)'}
Aumône: ${this.formatCurrency(this.data.accounts.alms.balance)} ${this.data.accounts.alms.sent ? '(Envoyée)' : '(À envoyer)'}
Épargne: ${this.formatCurrency(this.data.accounts.savings.balance)}
Investissement: ${this.formatCurrency(this.data.accounts.investment.balance)}
Disponible: ${this.formatCurrency(this.data.accounts.available.balance)}

STATISTIQUES DU MOIS:
---------------------
Total entrées: ${this.formatCurrency(monthlyIncome)}
Total dépenses: ${this.formatCurrency(monthlyExpense)}
Épargne accumulée: ${this.formatCurrency(monthlySavings)}
Investissement accumulé: ${this.formatCurrency(monthlyInvestment)}
Balance nette: ${this.formatCurrency(monthlyIncome - monthlyExpense)}

OBJECTIFS:
----------
Épargne: ${this.formatCurrency(this.data.settings.monthlySavingsGoal)} (${Math.min(100, Math.round((monthlySavings / this.data.settings.monthlySavingsGoal) * 100))}%)
Investissement: ${this.formatCurrency(this.data.settings.monthlyInvestmentGoal)} (${Math.min(100, Math.round((monthlyInvestment / this.data.settings.monthlyInvestmentGoal) * 100))}%)

Transactions ce mois: ${this.data.transactions.filter(t => {
    const d = new Date(t.date);
    return d.getMonth() + 1 === month && d.getFullYear() === year;
}).length}
                `.trim();
                
                const dataUri = 'data:text/plain;charset=utf-8,' + encodeURIComponent(report);
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', `rapport_ben_wallet_${month}_${year}.txt`);
                linkElement.click();
            },
            
            // Charger le tableau des transactions
            loadTransactionsTable() {
                const tbody = document.getElementById('all-transactions-body');
                tbody.innerHTML = '';
                
                // Filtrer les transactions du mois sélectionné
                const month = parseInt(document.getElementById('month-select').value);
                const year = parseInt(document.getElementById('year-select').value);
                
                const filteredTransactions = this.data.transactions.filter(transaction => {
                    const transactionDate = new Date(transaction.date);
                    return transactionDate.getMonth() + 1 === month && transactionDate.getFullYear() === year;
                });
                
                filteredTransactions.forEach(transaction => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-type', transaction.type);
                    row.setAttribute('data-allocated', transaction.allocated || false);
                    
                    const typeClass = transaction.type === 'income' ? 'type-income' : 'type-expense';
                    const typeText = transaction.type === 'income' ? 'Entrée' : 'Dépense';
                    
                    row.innerHTML = `
                        <td>${this.formatDateWithTime(transaction.date, transaction.time)}</td>
                        <td>${transaction.description || '-'}</td>
                        <td>${transaction.source}</td>
                        <td><span class="transaction-type ${typeClass}">${typeText}</span></td>
                        <td>${this.formatCurrency(transaction.amount)}</td>
                        <td>${transaction.fromAccount || (transaction.allocated ? 'Multiple' : '-')}</td>
                        <td>
                            ${transaction.allocated ? 
                                '<span class="status-badge status-sent">Allouée</span>' : 
                                '<span class="status-badge status-pending">Simple</span>'
                            }
                        </td>
                        <td>
                            <button class="btn btn-primary" style="padding: 5px 10px; font-size: 14px;" onclick="FinancialApp.viewTransactionDetails(${transaction.id})">
                                <i class="fas fa-eye"></i> Détails
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            },
            
            // Charger les transactions récentes
            loadRecentTransactions() {
                const tbody = document.getElementById('recent-transactions-body');
                tbody.innerHTML = '';
                
                // Prendre les 5 dernières transactions
                const recentTransactions = this.data.transactions.slice(0, 5);
                
                recentTransactions.forEach(transaction => {
                    const row = document.createElement('tr');
                    
                    const typeClass = transaction.type === 'income' ? 'type-income' : 'type-expense';
                    const typeText = transaction.type === 'income' ? 'Entrée' : 'Dépense';
                    
                    row.innerHTML = `
                        <td>${this.formatDateWithTime(transaction.date, transaction.time)}</td>
                        <td>${transaction.description || '-'}</td>
                        <td>${transaction.source}</td>
                        <td><span class="transaction-type ${typeClass}">${typeText}</span></td>
                        <td>${this.formatCurrency(transaction.amount)}</td>
                        <td>
                            ${transaction.allocated ? 
                                '<span class="status-badge status-sent">Allouée</span>' : 
                                '<span class="status-badge status-pending">Simple</span>'
                            }
                        </td>
                        <td>
                            <button class="btn btn-primary" style="padding: 5px 10px; font-size: 14px;" onclick="FinancialApp.viewTransactionDetails(${transaction.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            },
            
            // Voir les détails d'une transaction
            viewTransactionDetails(transactionId) {
                const transaction = this.data.transactions.find(t => t.id === transactionId);
                
                if (!transaction) return;
                
                document.getElementById('transaction-details-title').textContent = `Détails de la transaction #${transactionId}`;
                
                let detailsHtml = `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <strong>Date & Heure:</strong> <span>${this.formatDateWithTime(transaction.date, transaction.time)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <strong>Type:</strong> <span>${transaction.type === 'income' ? 'Entrée' : 'Dépense'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <strong>Montant:</strong> <span>${this.formatCurrency(transaction.amount)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <strong>Source/Destinataire:</strong> <span>${transaction.source}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <strong>Catégorie:</strong> <span>${transaction.category}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <strong>Description:</strong> <span>${transaction.description || '-'}</span>
                        </div>
                `;
                
                if (transaction.allocated && transaction.allocation) {
                    detailsHtml += `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                            <strong style="color: var(--primary-color);">Répartition automatique:</strong>
                            <div style="margin-top: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Dîme (${this.data.settings.tithePercent}%):</span> <span>${this.formatCurrency(transaction.allocation.tithe)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Offrande (${this.data.settings.offeringPercent}%):</span> <span>${this.formatCurrency(transaction.allocation.offering)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Bâtisseurs (${this.data.settings.buildersPercent}%):</span> <span>${this.formatCurrency(transaction.allocation.builders)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Aumône (${this.data.settings.almsPercent}%):</span> <span>${this.formatCurrency(transaction.allocation.alms)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Épargne (${this.data.settings.savingsPercent}%):</span> <span>${this.formatCurrency(transaction.allocation.savings)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Investissement (${this.data.settings.investmentPercent}%):</span> <span>${this.formatCurrency(transaction.allocation.investment)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Disponible (${this.data.settings.availablePercent}%):</span> <span>${this.formatCurrency(transaction.allocation.available)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                detailsHtml += `</div>`;
                
                document.getElementById('transaction-details-body').innerHTML = detailsHtml;
                document.getElementById('transaction-details-modal').classList.add('active');
            },
            
            // Charger l'historique des allocations
            loadAllocationsHistory() {
                const tbody = document.getElementById('allocations-history-body');
                tbody.innerHTML = '';
                
                // Filtrer les allocations du mois sélectionné
                const month = parseInt(document.getElementById('month-select').value);
                const year = parseInt(document.getElementById('year-select').value);
                
                const filteredAllocations = this.data.allocationsHistory.filter(allocation => {
                    const allocationDate = new Date(allocation.date);
                    return allocationDate.getMonth() + 1 === month && allocationDate.getFullYear() === year;
                });
                
                filteredAllocations.forEach(allocation => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${this.formatDateWithTime(allocation.date, allocation.time)}</td>
                        <td>${this.formatCurrency(allocation.amount)} (${allocation.source})</td>
                        <td>${this.formatCurrency(allocation.tithe)}</td>
                        <td>${this.formatCurrency(allocation.offering)}</td>
                        <td>${this.formatCurrency(allocation.builders)}</td>
                        <td>${this.formatCurrency(allocation.alms)}</td>
                        <td>${this.formatCurrency(allocation.savings)}</td>
                        <td>${this.formatCurrency(allocation.investment)}</td>
                        <td>${this.formatCurrency(allocation.available)}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            },
            
            // Charger les rapports
            loadReports() {
                // Calculer les totaux du mois
                const month = parseInt(document.getElementById('month-select').value);
                const year = parseInt(document.getElementById('year-select').value);
                
                let monthlyIncome = 0;
                let monthlyExpense = 0;
                let monthlySavings = 0;
                let monthlyInvestment = 0;
                
                this.data.transactions.forEach(transaction => {
                    const transactionDate = new Date(transaction.date);
                    if (transactionDate.getMonth() + 1 === month && transactionDate.getFullYear() === year) {
                        if (transaction.type === 'income') {
                            monthlyIncome += transaction.amount;
                            
                            if (transaction.allocated && transaction.allocation) {
                                monthlySavings += transaction.allocation.savings;
                                monthlyInvestment += transaction.allocation.investment;
                            }
                        } else {
                            monthlyExpense += transaction.amount;
                        }
                    }
                });
                
                // Mettre à jour les totaux
                document.getElementById('monthly-income-total').textContent = this.formatCurrency(monthlyIncome);
                document.getElementById('monthly-expense-total').textContent = this.formatCurrency(monthlyExpense);
                document.getElementById('monthly-savings-total').textContent = this.formatCurrency(monthlySavings);
                document.getElementById('monthly-investment-total').textContent = this.formatCurrency(monthlyInvestment);
                
                // Mettre à jour les objectifs
                const savingsGoal = this.data.settings.monthlySavingsGoal;
                const investmentGoal = this.data.settings.monthlyInvestmentGoal;
                
                const savingsProgress = savingsGoal > 0 ? Math.min(100, Math.round((monthlySavings / savingsGoal) * 100)) : 0;
                const investmentProgress = investmentGoal > 0 ? Math.min(100, Math.round((monthlyInvestment / investmentGoal) * 100)) : 0;
                
                document.getElementById('savings-goal-progress').textContent = `${savingsProgress}%`;
                document.getElementById('investment-goal-progress').textContent = `${investmentProgress}%`;
                document.getElementById('savings-goal-bar').style.width = `${savingsProgress}%`;
                document.getElementById('investment-goal-bar').style.width = `${investmentProgress}%`;
            },
            
            // Mettre à jour l'interface utilisateur
            updateUI() {
                // Mettre à jour le profil utilisateur
                this.updateUserProfileDisplay();
                
                // Calculer le solde total
                const totalBalance = 
                    this.data.accounts.tithe.balance +
                    this.data.accounts.offering.balance +
                    this.data.accounts.builders.balance +
                    this.data.accounts.alms.balance +
                    this.data.accounts.savings.balance +
                    this.data.accounts.investment.balance +
                    this.data.accounts.available.balance;
                
                // Mettre à jour les soldes
                document.getElementById('total-balance').textContent = this.formatCurrency(totalBalance);
                document.getElementById('tithe-balance').textContent = this.formatCurrency(this.data.accounts.tithe.balance);
                document.getElementById('offering-balance').textContent = this.formatCurrency(this.data.accounts.offering.balance);
                document.getElementById('builders-balance').textContent = this.formatCurrency(this.data.accounts.builders.balance);
                document.getElementById('alms-balance').textContent = this.formatCurrency(this.data.accounts.alms.balance);
                document.getElementById('savings-balance').textContent = this.formatCurrency(this.data.accounts.savings.balance);
                document.getElementById('investment-balance').textContent = this.formatCurrency(this.data.accounts.investment.balance);
                document.getElementById('available-balance').textContent = this.formatCurrency(this.data.accounts.available.balance);
                
                // Mettre à jour les comptes
                document.getElementById('savings-account-balance').textContent = this.formatCurrency(this.data.accounts.savings.balance);
                document.getElementById('investment-account-balance').textContent = this.formatCurrency(this.data.accounts.investment.balance);
                document.getElementById('available-account-balance').textContent = this.formatCurrency(this.data.accounts.available.balance);
                
                // Mettre à jour les dates de début
                document.getElementById('savings-start-date').textContent = this.data.accounts.savings.startDate;
                document.getElementById('investment-start-date').textContent = this.data.accounts.investment.startDate;
                
                // Mettre à jour les statuts d'envoi
                document.getElementById('tithe-status').textContent = this.data.accounts.tithe.sent ? 
                    `Envoyée le ${this.formatDateWithTime(this.data.accounts.tithe.sentDate, this.data.accounts.tithe.sentTime)}` : 'Non envoyée';
                
                document.getElementById('offering-status').textContent = this.data.accounts.offering.sent ? 
                    `Envoyée le ${this.formatDateWithTime(this.data.accounts.offering.sentDate, this.data.accounts.offering.sentTime)}` : 'Non envoyée';
                
                document.getElementById('builders-status').textContent = this.data.accounts.builders.sent ? 
                    `Envoyée le ${this.formatDateWithTime(this.data.accounts.builders.sentDate, this.data.accounts.builders.sentTime)}` : 'Non envoyée';
                
                document.getElementById('alms-status').textContent = this.data.accounts.alms.sent ? 
                    `Envoyée le ${this.formatDateWithTime(this.data.accounts.alms.sentDate, this.data.accounts.alms.sentTime)}` : 'Non envoyée';
                
                // Mettre à jour les badges d'allocation
                document.getElementById('tithe-allocation-status').textContent = this.data.accounts.tithe.sent ? 'Envoyée' : 'Non envoyée';
                document.getElementById('tithe-allocation-status').className = this.data.accounts.tithe.sent ? 'sent-badge' : 'not-sent-badge';
                
                document.getElementById('offering-allocation-status').textContent = this.data.accounts.offering.sent ? 'Envoyée' : 'Non envoyée';
                document.getElementById('offering-allocation-status').className = this.data.accounts.offering.sent ? 'sent-badge' : 'not-sent-badge';
                
                document.getElementById('builders-allocation-status').textContent = this.data.accounts.builders.sent ? 'Envoyée' : 'Non envoyée';
                document.getElementById('builders-allocation-status').className = this.data.accounts.builders.sent ? 'sent-badge' : 'not-sent-badge';
                
                document.getElementById('alms-allocation-status').textContent = this.data.accounts.alms.sent ? 'Envoyée' : 'Non envoyée';
                document.getElementById('alms-allocation-status').className = this.data.accounts.alms.sent ? 'sent-badge' : 'not-sent-badge';
                
                // Mettre à jour les objectifs
                document.getElementById('savings-target').textContent = this.formatCurrency(this.data.settings.monthlySavingsGoal);
                document.getElementById('investment-target').textContent = this.formatCurrency(this.data.settings.monthlyInvestmentGoal);
                
                // Mettre à jour les paramètres
                document.getElementById('tithe-percentage').value = this.data.settings.tithePercent;
                document.getElementById('offering-percentage').value = this.data.settings.offeringPercent;
                document.getElementById('builders-percentage').value = this.data.settings.buildersPercent;
                document.getElementById('alms-percentage').value = this.data.settings.almsPercent;
                document.getElementById('savings-percentage').value = this.data.settings.savingsPercent;
                document.getElementById('investment-percentage').value = this.data.settings.investmentPercent;
                document.getElementById('available-percentage').value = this.data.settings.availablePercent;
                document.getElementById('monthly-savings-goal').value = this.data.settings.monthlySavingsGoal;
                document.getElementById('monthly-investment-goal').value = this.data.settings.monthlyInvestmentGoal;
                
                // Charger les transactions récentes
                this.loadRecentTransactions();

                // Rendre la liste des catégories personnalisées et synchroniser le dropdown
                this.renderCategoriesList();
                this.updateTransactionCategoryDropdown();
            },

            // Taux de change simulés
            exchangeRates: {
                'FCFA': { EUR: 0.00152, USD: 0.00167, CAD: 0.00222, CHF: 0.00147, GBP: 0.00132 },
                'EUR': { FCFA: 655.957, USD: 1.10, CAD: 1.46, CHF: 0.97, GBP: 0.87 },
                'USD': { FCFA: 600, EUR: 0.91, CAD: 1.33, CHF: 0.88, GBP: 0.79 },
                'CAD': { FCFA: 450, EUR: 0.68, USD: 0.75, CHF: 0.66, GBP: 0.59 },
                'CHF': { FCFA: 680, EUR: 1.03, USD: 1.14, CAD: 1.52, GBP: 0.90 },
                'GBP': { FCFA: 760, EUR: 1.15, USD: 1.27, CAD: 1.69, CHF: 1.11 }
            },

            convertCurrency(amount, from, to) {
                if (from === to) return amount;
                if (this.exchangeRates[from] && this.exchangeRates[from][to]) {
                    return amount * this.exchangeRates[from][to];
                }
                // convert via EUR
                if (from !== 'EUR' && this.exchangeRates[from] && this.exchangeRates[from]['EUR']) {
                    const inEur = amount * this.exchangeRates[from]['EUR'];
                    if (to !== 'EUR' && this.exchangeRates['EUR'] && this.exchangeRates['EUR'][to]) {
                        return inEur * this.exchangeRates['EUR'][to];
                    }
                    return inEur;
                }
                return amount;
            },

            performConversion() {
                const amount = parseFloat(document.getElementById('convert-amount').value) || 0;
                const from = document.getElementById('convert-from').value;
                const to = document.getElementById('convert-to').value;
                if (amount <= 0) { alert('Veuillez entrer un montant valide'); return; }
                const result = this.convertCurrency(amount, from, to);
                const rate = this.exchangeRates[from]?.[to] || (this.exchangeRates[to]?.[from] ? 1 / this.exchangeRates[to][from] : null);
                const fmt = num => new Intl.NumberFormat('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
                document.getElementById('result-text').textContent = `${fmt(amount)} ${from} = ${fmt(result)} ${to}`;
                document.getElementById('rate-text').textContent = rate ? `Taux: 1 ${from} = ${fmt(rate)} ${to}` : '';
                document.getElementById('conversion-result').style.display = 'block';
            },

            loadExchangeRates() {
                const tbody = document.getElementById('exchange-rates-body');
                if (!tbody) return;
                tbody.innerHTML = '';
                const list = [ { code: 'FCFA', name: 'Franc CFA' }, { code: 'EUR', name: 'Euro' }, { code: 'USD', name: 'Dollar US' }, { code: 'CAD', name: 'Dollar Canadien' }, { code: 'CHF', name: 'Franc Suisse' }, { code: 'GBP', name: 'Livre Sterling' } ];
                list.forEach(c => {
                    const row = document.createElement('tr');
                    const rateEUR = this.exchangeRates['EUR']?.[c.code] || 'N/A';
                    const rateUSD = this.exchangeRates['USD']?.[c.code] || 'N/A';
                    row.innerHTML = `<td>${c.name}</td><td><strong>${c.code}</strong></td><td>${typeof rateEUR === 'number' ? rateEUR.toFixed(4) : rateEUR}</td><td>${typeof rateUSD === 'number' ? rateUSD.toFixed(4) : rateUSD}</td>`;
                    tbody.appendChild(row);
                });
            },

            setupCurrencyConverter() {
                document.getElementById('convert-btn')?.addEventListener('click', () => this.performConversion());
                ['convert-amount','convert-from','convert-to'].forEach(id => document.getElementById(id)?.addEventListener('input', () => this.performConversion()));
                this.loadExchangeRates();
            },

            // Données FAQ
            faqData: {
                general: [
                    { question: "Qu'est-ce que Ben Wallet ?", answer: "Ben Wallet est une application de gestion financière intelligente conçue pour vous aider à gérer vos finances personnelles, avec un système d'allocation automatique basé sur vos valeurs." },
                    { question: "Comment créer mon compte ?", answer: "Lors du premier lancement, vous serez invité à créer votre profil avec votre nom, statut, devise et mot de passe." },
                    { question: "Mon argent est-il sécurisé ?", answer: "Oui, toutes vos données sont stockées localement sur votre appareil. Aucune information n'est envoyée sur internet sans votre autorisation." }
                ],
                transactions: [
                    { question: "Comment ajouter une transaction ?", answer: "Rendez-vous dans l'onglet Tableau de bord, remplissez le formulaire 'Nouvelle transaction', choisissez le type, montant, source, etc. puis cliquez sur Enregistrer." },
                    { question: "Qu'est-ce que la répartition automatique ?", answer: "Pour chaque entrée d'argent, vous pouvez activer la répartition automatique qui divise le montant selon vos pourcentages configurés (dîme, offrande, épargne, etc.)." },
                    { question: "Comment modifier ou supprimer une transaction ?", answer: "Cliquez sur l'icône œil dans la liste des transactions pour voir les détails. Actuellement, les modifications directes ne sont pas disponibles, mais seront ajoutées dans une prochaine version." }
                ],
                accounts: [
                    { question: "Quels sont les différents comptes ?", answer: "Ben Wallet gère 7 comptes principaux : Dîme, Offrande, Bâtisseurs, Aumône, Épargne, Investissement, Disponible. Vous pouvez en ajouter d'autres dans les paramètres." },
                    { question: "Comment marquer une dîme comme envoyée ?", answer: "Dans l'onglet 'Mes comptes', cliquez sur 'Marquer comme envoyée' pour chaque compte religieux. Vous pourrez ajouter une preuve (screenshot, message, etc.)." },
                    { question: "Que faire si j'ai oublié mon mot de passe ?", answer: "Contactez l'administrateur qui pourra vous aider à réinitialiser votre compte. Pour des raisons de sécurité, le mot de passe n'est pas récupérable par vous-même." }
                ],
                budgets: [
                    { question: "Comment définir un budget ?", answer: "Dans l'onglet 'Paramètres', vous pouvez définir des objectifs mensuels d'épargne et d'investissement. La fonctionnalité de budgets par catégorie sera ajoutée prochainement." },
                    { question: "Comment voir mes progrès ?", answer: "L'onglet 'Rapports' montre vos objectifs avec des barres de progression et des graphiques détaillés." }
                ],
                technical: [
                    { question: "Comment installer Ben Wallet comme application ?", answer: "Sur mobile : ouvrez dans Chrome/Safari, allez dans le menu (...) et choisissez 'Ajouter à l'écran d'accueil'. Sur desktop, vous pouvez l'installer comme PWA." },
                    { question: "Comment sauvegarder mes données ?", answer: "Dans Paramètres, cliquez sur 'Exporter les données' pour créer une sauvegarde. Vous pouvez la restaurer ultérieurement." },
                    { question: "L'application fonctionne-t-elle hors ligne ?", answer: "Oui ! Ben Wallet est une PWA (Progressive Web App) qui fonctionne même sans connexion internet." }
                ]
            },

            loadFAQ() {
                const container = document.getElementById('faq-questions');
                if (!container) return;
                const activeCategory = document.querySelector('.faq-category.active')?.getAttribute('data-category') || 'general';
                const searchTerm = document.getElementById('faq-search')?.value.toLowerCase() || '';
                container.innerHTML = '';
                const questions = this.faqData[activeCategory] || [];
                questions.forEach((item) => {
                    if (searchTerm && !item.question.toLowerCase().includes(searchTerm) && !item.answer.toLowerCase().includes(searchTerm)) return;
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'faq-question';
                    questionDiv.innerHTML = `
                        <div class="faq-question-header">
                            <h4>${item.question}</h4>
                            <button class="faq-toggle"><i class="fas fa-chevron-down"></i></button>
                        </div>
                        <div class="faq-answer"><p>${item.answer}</p></div>
                    `;
                    questionDiv.addEventListener('click', () => {
                        questionDiv.classList.toggle('active');
                        const icon = questionDiv.querySelector('.faq-toggle i');
                        if (questionDiv.classList.contains('active')) { icon.classList.remove('fa-chevron-down'); icon.classList.add('fa-chevron-up'); } else { icon.classList.remove('fa-chevron-up'); icon.classList.add('fa-chevron-down'); }
                    });
                    container.appendChild(questionDiv);
                });
            },

            setupFAQ() {
                document.querySelectorAll('.faq-category').forEach(cat => {
                    cat.addEventListener('click', () => {
                        document.querySelectorAll('.faq-category').forEach(c => c.classList.remove('active'));
                        cat.classList.add('active');
                        this.loadFAQ();
                    });
                });
                document.getElementById('faq-search')?.addEventListener('input', () => this.loadFAQ());
                document.getElementById('contact-admin-btn')?.addEventListener('click', () => this.contactAdmin && this.contactAdmin());
                this.loadFAQ();
            },
            
            // Mettre à jour l'affichage du profil utilisateur
            updateUserProfileDisplay() {
                const profile = JSON.parse(localStorage.getItem('benWalletUserProfile'));
                if (!profile) return;
                
                // Mettre à jour l'avatar et le nom
                document.getElementById('user-avatar-display').textContent = profile.avatar;
                document.getElementById('user-name-display').textContent = profile.name;
                
                // Afficher le statut avec des couleurs différentes
                let statusText = '';
                let statusColor = '';
                
                switch(profile.status) {
                    case 'aspirant':
                        statusText = 'Aspirant';
                        statusColor = 'var(--info-color)';
                        break;
                    case 'enfant':
                        statusText = 'Enfant';
                        statusColor = 'var(--success-color)';
                        break;
                    case 'fils':
                        statusText = 'Fils';
                        statusColor = 'var(--primary-color)';
                        break;
                    case 'autre':
                        statusText = 'Membre';
                        statusColor = 'var(--warning-color)';
                        break;
                }
                
                const statusElement = document.getElementById('user-status-display');
                statusElement.textContent = statusText;
                statusElement.style.color = statusColor;
                statusElement.style.fontWeight = '600';
                
                // Mettre à jour les paramètres du profil
                document.getElementById('user-name-settings').value = profile.name;
                document.getElementById('user-status-settings').value = profile.status;
                document.getElementById('user-currency-settings').value = profile.currency;
                document.getElementById('user-avatar-settings').value = profile.avatar;
            },
            
            // Formater la monnaie
            formatCurrency(amount) {
                const profile = JSON.parse(localStorage.getItem('benWalletUserProfile'));
                const currency = profile ? profile.currency : 'FCFA';
                
                const currencySymbols = {
                    'FCFA': 'FCFA',
                    'EUR': '€',
                    'USD': '$',
                    'XAF': 'FCFA',
                    'XOF': 'FCFA',
                    'CAD': 'C$',
                    'CHF': 'CHF',
                    'GBP': '£'
                };
                
                const symbol = currencySymbols[currency] || currency;
                
                // Formater le nombre selon la devise
                const formatter = new Intl.NumberFormat('fr-FR', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 2
                });
                
                return `${formatter.format(amount)} ${symbol}`;
            },
            
            // Formater les dates avec heures
            formatDateWithTime(dateString, timeString = '') {
                const date = new Date(dateString);
                
                if (isNaN(date.getTime())) {
                    return dateString; // Retourner la chaîne originale si elle n'est pas valide
                }
                
                // Formater la date JJ/MM/AA
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear().toString().substr(-2);
                
                let formattedDate = `${day}/${month}/${year}`;
                
                // Ajouter l'heure si elle existe
                if (timeString) {
                    formattedDate += ` ${timeString}`;
                } else {
                    // Sinon, utiliser l'heure actuelle
                    const hours = date.getHours().toString().padStart(2, '0');
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    formattedDate += ` ${hours}:${minutes}`;
                }
                
                return formattedDate;
            },
            
            // Définir la date par défaut
            setDefaultDate() {
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const currentTime = now.toTimeString().substring(0, 5);
                
                // Pour le champ de date de transaction
                document.getElementById('transaction-date').value = today;
                document.getElementById('transaction-time').value = currentTime;
                
                // Pour le champ de preuve
                document.getElementById('proof-date').value = today;
                document.getElementById('proof-time').value = currentTime;
                
                // Définir le mois et l'année actuels
                const currentMonth = now.getMonth() + 1;
                const currentYear = now.getFullYear();
                
                document.getElementById('month-select').value = currentMonth;
                document.getElementById('year-select').value = currentYear;
                }
};

// === AJOUTER CETTE FONCTION GLOBALE ICI ===
// Fonction globale pour la création de profil
window.createUserProfile = function() {
    const userName = document.getElementById('user-name-create').value;
    const userStatus = document.getElementById('user-status-create').value;
    const userCurrency = document.getElementById('user-currency-create').value;
    let userAvatar = document.getElementById('user-avatar-create').value;
    const password = document.getElementById('user-password')?.value || '';
    const confirm = document.getElementById('user-confirm-password')?.value || '';
    const profession = document.getElementById('user-profession')?.value || '';
    const email = document.getElementById('user-email')?.value || '';
    const phone = document.getElementById('user-phone')?.value || '';
    
    if (!userName || userName.trim() === '') {
        alert('Veuillez entrer votre nom');
        return;
    }
    
    if (!userAvatar || userAvatar.trim() === '') {
        userAvatar = userName.substring(0, 2).toUpperCase();
    }
    
    if (!password || password.length < 4) { alert('Veuillez créer un mot de passe d\'au moins 4 caractères'); return; }
    if (password !== confirm) { alert('Les mots de passe ne correspondent pas'); return; }

    const hashedPassword = btoa(unescape(encodeURIComponent(password)));

    // Créer l'objet profil
    const userProfile = {
        name: userName.trim(),
        status: userStatus,
        currency: userCurrency,
        avatar: userAvatar,
        profession: profession,
        email: email,
        phone: phone,
        passwordHash: hashedPassword,
        createdAt: new Date().toISOString(),
        lastLogin: new Date().toISOString()
    };
    
    // Sauvegarder le profil
    localStorage.setItem('benWalletUserProfile', JSON.stringify(userProfile));
    
    // Initialiser les paramètres selon le statut
    FinancialApp.initializeSettingsByStatus(userStatus);
    
    // Fermer le modal
    document.getElementById('profile-creation-modal').classList.remove('active');
    
    // Redémarrer l'application
    FinancialApp.init();
};
// === FIN DE L'AJOUT ===

// Initialiser l'application lorsque la page est chargée
document.addEventListener('DOMContentLoaded', () => {
    FinancialApp.init();
});
        
        // Rendre l'application accessible globalement
        window.FinancialApp = FinancialApp;
        
        // Service Worker Registration supplémentaire
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>